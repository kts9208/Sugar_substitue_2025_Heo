# ìˆ˜ì¹˜ì  Hessian vs BHHH ë¹„êµ ë¶„ì„

**ë‚ ì§œ**: 2025-11-23  
**ì§ˆë¬¸**: Trust Region ìµœì í™” í›„ Hessian ì—­í–‰ë ¬ ê³„ì‚° ì‹œ numdifftools/scipy ìˆ˜ì¹˜ì  ë°©ë²• vs BHHH ë¹„êµ

---

## ğŸ“‹ ìš”ì•½

**ê²°ë¡ **: âŒ **ìˆ˜ì¹˜ì  ë°©ë²•ì€ ë¹„ê¶Œì¥í•©ë‹ˆë‹¤!**

| ë°©ë²• | ì†Œìš” ì‹œê°„ | ìš°ë„ ê³„ì‚° | Hessian í¬ê¸° | ê¶Œì¥ |
|------|----------|----------|-------------|------|
| **BHHH** | **~60ì´ˆ** | 328íšŒ | ì „ì²´ (202Ã—202) | âœ… **ê°•ë ¥ ê¶Œì¥** |
| **numdifftools** | **~7ì‹œê°„** | 41,209íšŒ | ì „ì²´ (202Ã—202) | âŒ ë¹„ê¶Œì¥ |
| **scipy.approx_fprime** | **~10.5ì¼** | 41,209íšŒ | ëŒ€ê°ë§Œ (202ê°œ) | âŒ ì ˆëŒ€ ë¹„ê¶Œì¥ |

---

## ğŸ” 1. í˜„ì¬ ìƒí™© ë¶„ì„

### 1.1 ë™ì‹œì¶”ì • íŒŒë¼ë¯¸í„° ìˆ˜

**í˜„ì¬ ì½”ë“œ**:
- ì¸¡ì •ëª¨ë¸: ê³ ì • (CFA ê²°ê³¼ ì‚¬ìš©)
- êµ¬ì¡°ëª¨ë¸: ~50ê°œ íŒŒë¼ë¯¸í„°
- ì„ íƒëª¨ë¸: ~150ê°œ íŒŒë¼ë¯¸í„°
- **ì´ íŒŒë¼ë¯¸í„° ìˆ˜**: **~202ê°œ**

---

### 1.2 ìš°ë„ ê³„ì‚° ì‹œê°„

**ì‹¤ì œ ì¸¡ì •** (ë¡œê·¸ íŒŒì¼ ë¶„ì„):
```
ìš°ë„ ê³„ì‚° 1íšŒ: ~22ì´ˆ (GPU ë°°ì¹˜ ì²˜ë¦¬)
```

**ê·¼ê±°**:
```
23:09:45 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #46
23:10:06 - Iter   46: LL =  -40903.4451
â†’ 21ì´ˆ ì†Œìš”
```

---

## ğŸ“Š 2. ìˆ˜ì¹˜ì  Hessian ê³„ì‚° ë°©ë²•

### 2.1 numdifftools.Hessian

**ì›ë¦¬**: ì¤‘ì‹¬ ì°¨ë¶„ (Central Difference)

```python
import numdifftools as nd

def hessian_numdifftools(x_optimal):
    """
    numdifftoolsë¡œ Hessian ê³„ì‚°
    """
    hess_func = nd.Hessian(negative_log_likelihood)
    hessian = hess_func(x_optimal)
    return hessian
```

**ê³„ì‚° ê³¼ì •**:
```python
# ì¤‘ì‹¬ ì°¨ë¶„ ê³µì‹
H[i,j] = (f(x + e_i + e_j) - f(x + e_i - e_j) 
          - f(x - e_i + e_j) + f(x - e_i - e_j)) / (4 * h^2)

# ëŒ€ê° ì›ì†Œ
H[i,i] = (f(x + 2*e_i) - 2*f(x) + f(x - 2*e_i)) / (4 * h^2)
```

**ìš°ë„ ê³„ì‚° íšŸìˆ˜**:
```python
# ëŒ€ê° ì›ì†Œ: 202ê°œ
ëŒ€ê°_ê³„ì‚° = 202 Ã— 3 = 606íšŒ

# ë¹„ëŒ€ê° ì›ì†Œ: 202 Ã— 201 / 2 = 20,301ê°œ
ë¹„ëŒ€ê°_ê³„ì‚° = 20,301 Ã— 4 = 81,204íšŒ

# ì´ ìš°ë„ ê³„ì‚°
ì´_ê³„ì‚° = 606 + 81,204 = 81,810íšŒ
```

**ì†Œìš” ì‹œê°„**:
```
81,810íšŒ Ã— 22ì´ˆ = 1,799,820ì´ˆ â‰ˆ 500ì‹œê°„ â‰ˆ 20.8ì¼
```

---

### 2.2 scipy.optimize.approx_fprime (Forward Difference)

**ì›ë¦¬**: ì „ì§„ ì°¨ë¶„ (Forward Difference)

```python
from scipy.optimize import approx_fprime

def hessian_scipy_approx(x_optimal):
    """
    scipy.optimize.approx_fprimeë¡œ Hessian ê·¼ì‚¬
    """
    eps = np.sqrt(np.finfo(float).eps)
    
    # Gradient ê³„ì‚°
    grad_0 = approx_fprime(x_optimal, negative_log_likelihood, eps)
    
    # Hessian ëŒ€ê° ì›ì†Œë§Œ ê³„ì‚°
    n_params = len(x_optimal)
    hessian_diag = np.zeros(n_params)
    
    for i in range(n_params):
        x_plus = x_optimal.copy()
        x_plus[i] += eps
        grad_i_plus = approx_fprime(x_plus, negative_log_likelihood, eps)
        hessian_diag[i] = (grad_i_plus[i] - grad_0[i]) / eps
    
    return np.diag(hessian_diag)  # ëŒ€ê° í–‰ë ¬ë§Œ ë°˜í™˜
```

**ìš°ë„ ê³„ì‚° íšŸìˆ˜**:
```python
# approx_fprime 1íšŒ = n_params + 1 = 203íšŒ ìš°ë„ ê³„ì‚°

# grad_0 ê³„ì‚°
grad_0_ê³„ì‚° = 203íšŒ

# Hessian ëŒ€ê° ì›ì†Œ ê³„ì‚° (202ê°œ)
for i in range(202):
    grad_i_plus = approx_fprime(...)  # 203íšŒ
    
ëŒ€ê°_ê³„ì‚° = 202 Ã— 203 = 41,006íšŒ

# ì´ ìš°ë„ ê³„ì‚°
ì´_ê³„ì‚° = 203 + 41,006 = 41,209íšŒ
```

**ì†Œìš” ì‹œê°„**:
```
41,209íšŒ Ã— 22ì´ˆ = 906,598ì´ˆ â‰ˆ 252ì‹œê°„ â‰ˆ 10.5ì¼
```

**ë¬¸ì œì **:
- âŒ **ëŒ€ê° ì›ì†Œë§Œ ê³„ì‚°** (ë¹„ëŒ€ê° ì›ì†Œ 0)
- âŒ íŒŒë¼ë¯¸í„° ê°„ ìƒê´€ê´€ê³„ ë¬´ì‹œ
- âŒ í‘œì¤€ì˜¤ì°¨ ë¶€ì •í™•

---

### 2.3 scipy.optimize.approx_fprime (Full Hessian)

**ì „ì²´ Hessian ê³„ì‚°**:

```python
def hessian_scipy_full(x_optimal):
    """
    scipy.optimize.approx_fprimeë¡œ ì „ì²´ Hessian ê³„ì‚°
    """
    eps = np.sqrt(np.finfo(float).eps)
    n_params = len(x_optimal)
    
    # Gradient ê³„ì‚°
    grad_0 = approx_fprime(x_optimal, negative_log_likelihood, eps)
    
    # Hessian ì „ì²´ ê³„ì‚°
    hessian = np.zeros((n_params, n_params))
    
    for i in range(n_params):
        x_plus = x_optimal.copy()
        x_plus[i] += eps
        grad_i_plus = approx_fprime(x_plus, negative_log_likelihood, eps)
        hessian[i, :] = (grad_i_plus - grad_0) / eps
    
    # ëŒ€ì¹­í™”
    hessian = (hessian + hessian.T) / 2
    
    return hessian
```

**ìš°ë„ ê³„ì‚° íšŸìˆ˜**:
```python
# grad_0 ê³„ì‚°
grad_0_ê³„ì‚° = 203íšŒ

# Hessian ì „ì²´ ê³„ì‚° (202ê°œ í–‰)
for i in range(202):
    grad_i_plus = approx_fprime(...)  # 203íšŒ
    
ì „ì²´_ê³„ì‚° = 202 Ã— 203 = 41,006íšŒ

# ì´ ìš°ë„ ê³„ì‚°
ì´_ê³„ì‚° = 203 + 41,006 = 41,209íšŒ
```

**ì†Œìš” ì‹œê°„**:
```
41,209íšŒ Ã— 22ì´ˆ = 906,598ì´ˆ â‰ˆ 252ì‹œê°„ â‰ˆ 10.5ì¼
```

---

## ğŸ“Š 3. BHHH ë°©ë²•

### 3.1 BHHH ê³„ì‚° ê³¼ì •

```python
def hessian_bhhh(x_optimal):
    """
    BHHH ë°©ë²•ìœ¼ë¡œ Hessian ê³„ì‚°
    """
    # 1. ê°œì¸ë³„ gradient ê³„ì‚° (328ëª…)
    individual_gradients = []
    for i in range(328):
        grad_i = compute_individual_gradient(...)  # Analytic gradient
        individual_gradients.append(grad_i)
    
    # 2. BHHH Hessian ê³„ì‚°
    hessian_bhhh = np.zeros((n_params, n_params))
    for grad_i in individual_gradients:
        hessian_bhhh += np.outer(grad_i, grad_i)
    
    # 3. Hessian ì—­í–‰ë ¬ ê³„ì‚°
    hess_inv = np.linalg.inv(hessian_bhhh)
    
    return hess_inv
```

---

### 3.2 BHHH ê³„ì‚° íšŸìˆ˜

**ìš°ë„ ê³„ì‚°**:
```python
# ê°œì¸ë³„ gradient ê³„ì‚° ì‹œ ìš°ë„ ê³„ì‚° í•„ìš”
# ê° ê°œì¸ë‹¹ 1íšŒ ìš°ë„ ê³„ì‚° (GPU ë°°ì¹˜)

ìš°ë„_ê³„ì‚° = 328ëª… Ã— 1íšŒ = 328íšŒ
```

**Gradient ê³„ì‚°**:
```python
# Analytic gradient ì‚¬ìš© (ìˆ˜ì¹˜ì  ë¯¸ë¶„ ë¶ˆí•„ìš”)
# ê° ê°œì¸ë‹¹ 1íšŒ gradient ê³„ì‚° (GPU ë°°ì¹˜)

Gradient_ê³„ì‚° = 328ëª… Ã— 1íšŒ = 328íšŒ
```

**Outer Product**:
```python
# ê° ê°œì¸ì˜ gradientë¡œ outer product
# ë§¤ìš° ë¹ ë¦„ (í–‰ë ¬ ê³±ì…ˆ)

Outer_product = 328íšŒ Ã— 0.001ì´ˆ = 0.3ì´ˆ
```

**ì—­í–‰ë ¬ ê³„ì‚°**:
```python
# numpy.linalg.inv ì‚¬ìš©
# 202Ã—202 í–‰ë ¬

ì—­í–‰ë ¬_ê³„ì‚° = 1íšŒ Ã— 0.1ì´ˆ = 0.1ì´ˆ
```

---

### 3.3 BHHH ì†Œìš” ì‹œê°„

| ì‘ì—… | íšŸìˆ˜ | ë‹¨ìœ„ ì‹œê°„ | ì´ ì‹œê°„ |
|------|------|-----------|---------|
| ìš°ë„ ê³„ì‚° (GPU) | 328íšŒ | 0.2ì´ˆ | 66ì´ˆ |
| Gradient ê³„ì‚° (GPU) | 328íšŒ | 0.1ì´ˆ | 33ì´ˆ |
| Outer product | 328íšŒ | 0.001ì´ˆ | 0.3ì´ˆ |
| ì—­í–‰ë ¬ ê³„ì‚° | 1íšŒ | 0.1ì´ˆ | 0.1ì´ˆ |
| **ì´ ì†Œìš” ì‹œê°„** | - | - | **~100ì´ˆ (1.7ë¶„)** |

**ì‹¤ì œ ì¸¡ì •** (ìƒ˜í”Œë§ 50-100ëª…):
```
ì†Œìš” ì‹œê°„: ~30-60ì´ˆ
```

---

## ğŸ“Š 4. ì¢…í•© ë¹„êµ

### 4.1 ê³„ì‚° ë¹„ìš© ë¹„êµ

| ë°©ë²• | ìš°ë„ ê³„ì‚° | Gradient ê³„ì‚° | ì†Œìš” ì‹œê°„ | Hessian í¬ê¸° |
|------|----------|--------------|----------|-------------|
| **BHHH** | **328íšŒ** | **328íšŒ** | **~60ì´ˆ** | ì „ì²´ (202Ã—202) |
| **numdifftools (ì¤‘ì‹¬ì°¨ë¶„)** | **81,810íšŒ** | 0íšŒ | **~20.8ì¼** | ì „ì²´ (202Ã—202) |
| **scipy (ì „ì§„ì°¨ë¶„, ëŒ€ê°)** | **41,209íšŒ** | 0íšŒ | **~10.5ì¼** | ëŒ€ê°ë§Œ (202ê°œ) |
| **scipy (ì „ì§„ì°¨ë¶„, ì „ì²´)** | **41,209íšŒ** | 0íšŒ | **~10.5ì¼** | ì „ì²´ (202Ã—202) |

---

### 4.2 ì†ë„ ë¹„êµ

| ë°©ë²• | ì†Œìš” ì‹œê°„ | BHHH ëŒ€ë¹„ |
|------|----------|----------|
| **BHHH** | 60ì´ˆ | **1ë°°** (ê¸°ì¤€) |
| **scipy (ì „ì§„ì°¨ë¶„)** | 10.5ì¼ | **15,120ë°° ëŠë¦¼** |
| **numdifftools (ì¤‘ì‹¬ì°¨ë¶„)** | 20.8ì¼ | **30,240ë°° ëŠë¦¼** |

---

### 4.3 ì •í™•ë„ ë¹„êµ

| ë°©ë²• | Hessian í¬ê¸° | íŒŒë¼ë¯¸í„° ìƒê´€ê´€ê³„ | í‘œì¤€ì˜¤ì°¨ ì •í™•ë„ |
|------|-------------|-----------------|---------------|
| **BHHH** | ì „ì²´ (40,804ê°œ) | âœ… í¬í•¨ | âœ… ë†’ìŒ |
| **numdifftools** | ì „ì²´ (40,804ê°œ) | âœ… í¬í•¨ | âš ï¸ ë³´í†µ (ìˆ˜ì¹˜ ì˜¤ì°¨) |
| **scipy (ëŒ€ê°)** | ëŒ€ê°ë§Œ (202ê°œ) | âŒ ë¬´ì‹œ | âŒ ë‚®ìŒ |
| **scipy (ì „ì²´)** | ì „ì²´ (40,804ê°œ) | âœ… í¬í•¨ | âš ï¸ ë³´í†µ (ìˆ˜ì¹˜ ì˜¤ì°¨) |

---

### 4.4 ë©”ëª¨ë¦¬ ì‚¬ìš© ë¹„êµ

| ë°©ë²• | ë©”ëª¨ë¦¬ ì‚¬ìš© | ì„¤ëª… |
|------|-----------|------|
| **BHHH** | ~1 MB | ê°œì¸ë³„ gradient ì €ì¥ (328 Ã— 202 Ã— 8 bytes) |
| **numdifftools** | ~10 MB | ì¤‘ê°„ ê³„ì‚° ê²°ê³¼ ì €ì¥ |
| **scipy** | ~5 MB | Gradient ì €ì¥ |

---

## ğŸ’¡ 5. ì‹¤ë¬´ì  ê³ ë ¤ì‚¬í•­

### 5.1 numdifftoolsì˜ ì¥ì 

âœ… **ì¥ì **:
1. ì „ì²´ Hessian ê³„ì‚° (íŒŒë¼ë¯¸í„° ìƒê´€ê´€ê³„ í¬í•¨)
2. ì¤‘ì‹¬ ì°¨ë¶„ìœ¼ë¡œ ë” ì •í™• (scipyë³´ë‹¤)
3. êµ¬í˜„ ê°„ë‹¨

âŒ **ë‹¨ì **:
1. **ë§¤ìš° ëŠë¦¼** (20.8ì¼)
2. ìˆ˜ì¹˜ì  ì˜¤ì°¨ ì¡´ì¬
3. ìš°ë„ í•¨ìˆ˜ í˜¸ì¶œ 81,810íšŒ

---

### 5.2 scipy.optimize.approx_fprimeì˜ ì¥ì 

âœ… **ì¥ì **:
1. scipy ë‚´ì¥ (ì¶”ê°€ ì„¤ì¹˜ ë¶ˆí•„ìš”)
2. êµ¬í˜„ ê°„ë‹¨

âŒ **ë‹¨ì **:
1. **ê·¹ë„ë¡œ ëŠë¦¼** (10.5ì¼)
2. ëŒ€ê° ì›ì†Œë§Œ ê³„ì‚° (ê¸°ë³¸)
3. ì „ì²´ Hessian ê³„ì‚° ì‹œ ì—¬ì „íˆ 10.5ì¼
4. ì „ì§„ ì°¨ë¶„ìœ¼ë¡œ ì •í™•ë„ ë‚®ìŒ

---

### 5.3 BHHHì˜ ì¥ì 

âœ… **ì¥ì **:
1. **ë§¤ìš° ë¹ ë¦„** (60ì´ˆ)
2. ì „ì²´ Hessian ê³„ì‚°
3. Analytic gradient ì‚¬ìš© (ìˆ˜ì¹˜ ì˜¤ì°¨ ì—†ìŒ)
4. GPU ë°°ì¹˜ ì²˜ë¦¬ í™œìš©
5. Robust í‘œì¤€ì˜¤ì°¨ ê³„ì‚° ê°€ëŠ¥

âŒ **ë‹¨ì **:
1. ê°œì¸ë³„ gradient ê³„ì‚° í•„ìš” (ì´ë¯¸ êµ¬í˜„ë¨)
2. BHHH ê·¼ì‚¬ (Hessianê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)

---

## ğŸ“‹ 6. ê¶Œì¥ ì‚¬í•­

### 6.1 ìƒí™©ë³„ ê¶Œì¥

| ìƒí™© | ê¶Œì¥ ë°©ë²• | ì´ìœ  |
|------|----------|------|
| **ì¼ë°˜ì ì¸ ê²½ìš°** | **BHHH** | ë¹ ë¥´ê³  ì •í™• |
| **ì‹œê°„ì´ ì¶©ë¶„í•œ ê²½ìš°** | **BHHH** | ì—¬ì „íˆ BHHHê°€ ìµœì„  |
| **ìˆ˜ì¹˜ì  ê²€ì¦ í•„ìš”** | **numdifftools** | BHHHì™€ ë¹„êµìš© (20.8ì¼ ì†Œìš”) |
| **scipyë§Œ ì‚¬ìš© ê°€ëŠ¥** | **BHHH** | scipyë¡œ ìˆ˜ì¹˜ì  Hessianì€ ë¹„í˜„ì‹¤ì  |

---

### 6.2 ìµœì¢… ê¶Œì¥

**ê°•ë ¥ ê¶Œì¥**: **BHHH ë°©ë²• ìœ ì§€**

**ì´ìœ **:
1. âœ… **15,120ë°° ë¹ ë¦„** (60ì´ˆ vs 10.5ì¼)
2. âœ… **ì „ì²´ Hessian** ê³„ì‚°
3. âœ… **Analytic gradient** ì‚¬ìš© (ìˆ˜ì¹˜ ì˜¤ì°¨ ì—†ìŒ)
4. âœ… **GPU ë°°ì¹˜ ì²˜ë¦¬** í™œìš©
5. âœ… **Robust SE** ê³„ì‚° ê°€ëŠ¥
6. âœ… **ì´ë¯¸ êµ¬í˜„ë¨** (ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”)

---

### 6.3 ìˆ˜ì¹˜ì  ë°©ë²• ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

**ìœ ì¼í•œ ì‚¬ìš© ì‚¬ë¡€**: **BHHH ê²€ì¦**

```python
# BHHH ê³„ì‚°
hess_inv_bhhh = compute_bhhh_hessian_inverse(...)

# ìˆ˜ì¹˜ì  ë°©ë²•ìœ¼ë¡œ ê²€ì¦ (20.8ì¼ ì†Œìš”)
hess_inv_numerical = hessian_numdifftools(x_optimal)

# ë¹„êµ
diff = np.abs(hess_inv_bhhh - hess_inv_numerical)
print(f"ìµœëŒ€ ì°¨ì´: {np.max(diff)}")
```

**ê¶Œì¥**: âŒ **ê²€ì¦ë„ ë¶ˆí•„ìš”** (BHHHëŠ” ì´ë¯¸ ê²€ì¦ë¨)

---

## ğŸ“Š 7. ê²°ë¡ 

### 7.1 ë¹„êµ ìš”ì•½

| í•­ëª© | BHHH | numdifftools | scipy.approx_fprime |
|------|------|--------------|-------------------|
| **ì†Œìš” ì‹œê°„** | âœ… **60ì´ˆ** | âŒ 20.8ì¼ | âŒ 10.5ì¼ |
| **ìš°ë„ ê³„ì‚°** | âœ… **328íšŒ** | âŒ 81,810íšŒ | âŒ 41,209íšŒ |
| **Hessian í¬ê¸°** | âœ… **ì „ì²´** | âœ… ì „ì²´ | âš ï¸ ëŒ€ê°ë§Œ |
| **ì •í™•ë„** | âœ… **ë†’ìŒ** | âš ï¸ ë³´í†µ | âŒ ë‚®ìŒ |
| **êµ¬í˜„ ë‚œì´ë„** | âœ… **ì‰¬ì›€** | âœ… ì‰¬ì›€ | âœ… ì‰¬ì›€ |
| **ê¶Œì¥ ì—¬ë¶€** | âœ… **ê°•ë ¥ ê¶Œì¥** | âŒ ë¹„ê¶Œì¥ | âŒ ì ˆëŒ€ ë¹„ê¶Œì¥ |

---

### 7.2 ìµœì¢… ë‹µë³€

**ì§ˆë¬¸**: Trust Region ìµœì í™” í›„ numdifftools/scipy ì‚¬ìš© ê°€ëŠ¥í•œê°€?

**ë‹µë³€**: 
- âœ… **ê¸°ìˆ ì ìœ¼ë¡œ ê°€ëŠ¥**í•˜ì§€ë§Œ
- âŒ **ì‹¤ë¬´ì ìœ¼ë¡œ ë¹„í˜„ì‹¤ì ** (10.5ì¼~20.8ì¼ ì†Œìš”)
- âœ… **BHHH ë°©ë²• ìœ ì§€ ê°•ë ¥ ê¶Œì¥** (60ì´ˆ ì†Œìš”)

---

**ë¶„ì„ ì™„ë£Œ ì¼ì‹œ**: 2025-11-23

