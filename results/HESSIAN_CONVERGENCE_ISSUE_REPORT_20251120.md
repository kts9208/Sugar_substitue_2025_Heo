# Hessian 근사 문제 및 수렴성 진단 보고서

**날짜**: 2025-11-20  
**로그 파일**: `simultaneous_estimation_log_20251120_192842.txt`  
**분석자**: AI Assistant

---

## 📋 요약

동시추정 과정에서 **Hessian 근사의 ill-conditioning**으로 인해 최적화가 조기에 중단되었습니다.

### 핵심 문제
- ✅ **Iteration #1**: 정상 작동 (LL: -3662.12 → -3224.53)
- ❌ **Iteration #2~5**: 탐색 방향이 0으로 고정되어 파라미터 업데이트 불가
- ❌ **수렴 실패**: Gradient norm이 여전히 큼 (21.0) but 탐색 중단

---

## 🔍 상세 분석

### 1. Hessian 업데이트 문제

#### y_k/s_k 비율 (Gradient 변화 / 파라미터 변화)

| Iteration | s_k norm | y_k norm | 비율 | 평가 |
|-----------|----------|----------|------|------|
| 2 | 0.747 | 515.4 | **690.2** | ❌ 심각 |
| 3 | 0.561 | 171.6 | **305.7** | ⚠️ 경고 |
| 4 | 0.313 | 72.9 | **233.2** | ⚠️ 경고 |
| 5 | 0.141 | 16.4 | **116.1** | ⚠️ 경고 |
| 6 | 0.241 | 13.9 | **57.7** | ⚠️ 주의 |

**문제점**:
- 비율이 500 이상이면 Hessian이 매우 큰 값으로 근사됨
- Gradient 변화가 파라미터 변화에 비해 과도하게 큼
- BFGS 업데이트가 수치적으로 불안정해짐

#### ρ 값 (Hessian 업데이트 강도)

| Iteration | ρ = 1/(s_k^T · y_k) | 평가 |
|-----------|---------------------|------|
| 2 | 0.0031 | ✅ 정상 |
| 3 | 0.0113 | ✅ 정상 |
| 4 | 0.0491 | ⚠️ 주의 |
| 5 | **0.6757** | ❌ 과도함 |
| 6 | **0.4059** | ❌ 과도함 |

**문제점**:
- ρ > 0.1이면 Hessian 업데이트가 과도함
- Iteration #5에서 ρ = 0.68로 급증
- Hessian이 ill-conditioned 상태로 진입

### 2. 탐색 방향 문제

#### Iteration #3부터 탐색 방향이 0

```
탐색 방향 d norm: 0.000000e+00
d와 -grad의 코사인 유사도: 0.000000
```

**원인**:
- Hessian 근사 H가 매우 큰 값을 가짐
- d = -H^(-1) · grad 계산 시 H^(-1)이 거의 0이 됨
- 결과적으로 탐색 방향 d ≈ 0

### 3. 성분별 분석 (Iteration #2)

| 성분 | s_k | y_k | 비율 | 평가 |
|------|-----|-----|------|------|
| [0] | 8.08e-05 | 6.94e-18 | 0.00 | 구조모델 (거의 변화 없음) |
| [1] | -2.07e-05 | 3.71e-06 | 0.18 | 구조모델 (거의 변화 없음) |
| [2] | 0.266 | -7.45 | 28.0 | 선택모델 ASC |
| [3] | 0.294 | 172.9 | **589.0** | ❌ 선택모델 ASC (심각) |
| [4] | 0.350 | 44.7 | 127.8 | 선택모델 beta |

**핵심 발견**:
- **성분 [3] (asc_sugar_free)의 비율이 589로 극단적으로 큼**
- 구조모델 파라미터는 거의 변화하지 않음 (s_k ≈ 0)
- 선택모델 파라미터의 gradient 변화가 과도함

---

## 🎯 근본 원인

### 1. 파라미터 스케일 불균형
- 구조모델: gamma ≈ 0.1 (작음)
- 선택모델: asc, beta ≈ 0.1~1.7 (큼)
- **스케일링이 비활성화**되어 있어 불균형 해소 불가

### 2. Gradient 크기 차이
- 구조모델 gradient: ~0.01 (매우 작음)
- 선택모델 gradient: ~100~600 (매우 큼)
- **10,000배 이상의 차이**

### 3. 초기값 문제
- 모든 파라미터가 0.1로 동일하게 설정됨
- 선택모델 파라미터는 더 큰 초기값이 필요

---

## 💡 해결책

### 🥇 1순위: 파라미터 스케일링 활성화 + Hessian 리셋

```python
# 설정 변경
config.estimation.use_parameter_scaling = True  # 현재 False
config.estimation.reset_hessian_every = 10      # 새로 추가
```

**효과**:
- Gradient 크기에 따라 자동 스케일링
- 주기적 Hessian 리셋으로 ill-conditioning 방지

### 🥈 2순위: Trust Region 방법 사용

```python
config.estimation.optimizer = 'trust-constr'  # 현재 'L-BFGS-B'
```

**효과**:
- 파라미터 변화를 제한하여 안정성 향상
- Hessian 근사 문제에 덜 민감

### 🥉 3순위: 초기값 개선

```python
# 순차추정 결과 사용
initial_params = {
    'structural': {
        'gamma_health_concern_to_perceived_benefit': 0.5,  # 현재 0.1
        'gamma_perceived_benefit_to_purchase_intention': 0.3,
    },
    'choice': {
        'asc_sugar': 0.5,
        'asc_sugar_free': 1.5,
        'beta_health_label': 1.0,
        'beta_price': -0.5,
        'theta_sugar_purchase_intention': 0.05,
        'theta_sugar_free_purchase_intention': 0.05,
    }
}
```

---

## 📊 수렴 조건 분석

| Iteration | ftol | gtol | 평가 |
|-----------|------|------|------|
| 1 | N/A | 448.5 | ❌ 미달 |
| 2 | 0.079 | 213.8 | ❌ 미달 |
| 3 | 0.028 | 63.9 | ❌ 미달 |
| 4 | 0.005 | 21.0 | ❌ 미달 |
| 5 | 0.0008 | 11.4 | ❌ 미달 |

**기준**: ftol < 1e-3 AND gtol < 1e-3

**문제**:
- ftol은 개선되고 있으나 (0.079 → 0.0008)
- gtol이 여전히 기준보다 훨씬 큼 (11.4 >> 1e-3)
- 탐색 방향이 0이 되어 더 이상 개선 불가

---

## ✅ 권장 조치

### 즉시 조치
1. **파라미터 스케일링 활성화**
2. **Hessian 주기적 리셋 (10 iterations마다)**
3. **초기값을 순차추정 결과로 변경**

### 추가 조치 (필요시)
4. Trust Region 방법 시도
5. Line search 강화 (maxls=50)
6. Gradient 계산 검증

---

## 📝 결론

현재 동시추정은 **Hessian 근사의 ill-conditioning**으로 인해 실패했습니다. 
주요 원인은:
1. 파라미터 스케일 불균형 (구조모델 vs 선택모델)
2. Gradient 크기 차이 (10,000배)
3. 스케일링 비활성화

**권장 해결책**은 파라미터 스케일링 활성화와 Hessian 주기적 리셋입니다.

