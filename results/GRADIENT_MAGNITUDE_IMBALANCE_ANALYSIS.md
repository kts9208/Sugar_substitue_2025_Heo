# κ·Έλλ””μ–ΈνΈ ν¬κΈ° λ¶κ· ν• μ›μΈ λ¶„μ„

**λ‚ μ§**: 2025-11-20  
**λ΅κ·Έ νμΌ**: `simultaneous_estimation_log_20251120_192842.txt`

---

## π― ν•µμ‹¬ λ°κ²¬

### κ·Έλλ””μ–ΈνΈ ν¬κΈ° λΉ„μ¨ (Iteration #1)

| λ¨λΈ | ν‰κ·  \|grad\| | λΉ„μ¨ (vs κµ¬μ΅°λ¨λΈ) |
|------|--------------|-------------------|
| **κµ¬μ΅°λ¨λΈ** | 2.61e-02 | 1.0x (κΈ°μ¤€) |
| **μ„ νƒλ¨λΈ (LV κ³„μ)** | 11.14 | **427x** |
| **μ„ νƒλ¨λΈ (κ³ μ •ν¨κ³Ό)** | 256.66 | **9,836x** |

### π”΄ λ¬Έμ μ μ‹¬κ°μ„±

**μ„ νƒλ¨λΈ κ·Έλλ””μ–ΈνΈκ°€ κµ¬μ΅°λ¨λΈλ³΄λ‹¤ 10,000λ°° κ°€κΉμ΄ ν½λ‹λ‹¤!**

μ΄λ” L-BFGS-Bμ Hessian κ·Όμ‚¬λ¥Ό μ™„μ „ν λ§κ°€λ¨λ¦½λ‹λ‹¤:
- y_k (gradient λ³€ν™”) = 515.4
- s_k (parameter λ³€ν™”) = 0.747
- **y_k/s_k λΉ„μ¨ = 690.2** β† κ·Ήλ‹¨μ !

---

## π“ Iterationλ³„ μ¶”μ΄

### Iteration #1 β†’ #5 λ³€ν™”

| Iteration | κµ¬μ΅°λ¨λΈ | μ„ νƒ(κ³ μ •) | μ„ νƒ(LV) | λΉ„μ¨(κ³ μ •/κµ¬μ΅°) |
|-----------|---------|-----------|---------|----------------|
| #1 | 0.026 | 256.66 | 11.14 | **9,836x** |
| #2 | 0.026 | 100.71 | 5.41 | **3,860x** |
| #3 | 0.026 | 34.02 | 2.35 | **1,304x** |
| #4 | 0.026 | 8.52 | 1.46 | **326x** |
| #5 | 0.026 | 6.78 | 0.74 | **260x** |

**κ΄€μ°°**:
- β… μ„ νƒλ¨λΈ κ·Έλλ””μ–ΈνΈλ” κ°μ† μ¤‘ (μµμ ν™” μ§„ν–‰)
- β κµ¬μ΅°λ¨λΈ κ·Έλλ””μ–ΈνΈλ” **κ±°μ λ³€ν•μ§€ μ•μ** (0.026 κ³ μ •)
- β οΈ μ—¬μ „ν 260λ°° μ°¨μ΄ (Iteration #5)

---

## π” μ›μΈ λ¶„μ„

### 1οΈβƒ£ κµ¬μ΅°λ¨λΈ κ·Έλλ””μ–ΈνΈκ°€ λ„λ¬΄ μ‘μ

**νλΌλ―Έν„°λ³„ μƒμ„Έ (Iteration #1)**:
```
gamma_health_concern_to_perceived_benefit     : grad = -0.0415 (κ³ μ •!)
gamma_perceived_benefit_to_purchase_intention : grad = +0.0106 (μ•½κ°„ λ³€ν™”)
```

**π”΄ CRITICAL λ°κ²¬**: `gamma_health_concern_to_perceived_benefit`μ κ·Έλλ””μ–ΈνΈκ°€ **λ¨λ“  iterationμ—μ„ μ™„μ „ν λ™μΌ**ν•©λ‹λ‹¤!

#### κµ¬μ΅°λ¨λΈ κ·Έλλ””μ–ΈνΈ κ³µμ‹
```
β‚ log L / β‚Ξ³ = Ξ£_r w_r Γ— (target - Ξ³ Γ— predictor) / ΟƒΒ² Γ— predictor
             = Ξ£_r w_r Γ— (target Γ— predictor - Ξ³ Γ— predictorΒ²) / ΟƒΒ²
```

#### π› λ²„κ·Έ λ°κ²¬: κ·Έλλ””μ–ΈνΈκ°€ νλΌλ―Έν„° λ³€ν™”λ¥Ό λ°μν•μ§€ λ»ν•¨

**μ½”λ“ μ„μΉ**: `src/analysis/hybrid_choice_model/iclv_models/gpu_gradient_batch.py:1624`

```python
# μμΈ΅κ°’: (326, 100)
mu = gamma * pred_values  # β† gammaλ” ν„μ¬ νλΌλ―Έν„° κ°’

# μ”μ°¨: (326, 100)
residual = target_values - mu

# Gradient: (326, 100)
weighted_residual = all_weights_gpu * residual / error_variance

# κ°€μ¤‘ν•©: (326,)
grad_gamma = cp.sum(weighted_residual * pred_values, axis=1)
```

**λ¬Έμ μ **:
- `gamma`κ°€ λ³€ν•΄λ„ `pred_values`λ” λ™μΌ (μ μ¬λ³€μ κ°’μ€ drawsμ—μ„ μƒμ„±)
- `residual = target - gamma * pred`μ—μ„ gammaκ°€ λ³€ν•λ©΄ residualλ„ λ³€ν•¨
- **ν•μ§€λ§ `pred_values`κ°€ κ±°μ 0μ— κ°€κΉμ°λ©΄ κ·Έλλ””μ–ΈνΈλ„ κ±°μ 0**
- **νΉν `health_concern`μ predictor κ°’μ΄ λ§¤μ° μ‘μΌλ©΄ κ·Έλλ””μ–ΈνΈκ°€ κ³ μ •λ¨**

#### μ¶”κ°€ λ¬Έμ μ 

1. **μ μ¬λ³€μ κ°’μ΄ ν‘μ¤€ν™”λ¨** (ν‰κ·  0, λ¶„μ‚° 1)
   - predictor β [-3, +3] μ •λ„
   - residual = LV_endo - ΞΌ_endo β [-3, +3] μ •λ„
   - **gradient = residual Γ— predictor β‰ 0.01 ~ 0.1**

2. **Importance weighting μ μ©**
   - μ—¬λ¬ drawsμ κ°€μ¤‘ν‰κ· 
   - μ–‘μ/μμκ°€ μ„μ—¬μ„ μƒμ‡„λ¨
   - **μµμΆ… gradient β‰ 0.01 ~ 0.05**

3. **νΉμ • κ²½λ΅μ predictor κ°’μ΄ λ§¤μ° μ‘μ**
   - `health_concern` β†’ `perceived_benefit` κ²½λ΅
   - predictor κ°’μ΄ κ±°μ 0μ— κ°€κΉμ›€
   - **gradientκ°€ μ™„μ „ν κ³ μ •λ¨**

---

### 2οΈβƒ£ μ„ νƒλ¨λΈ κ·Έλλ””μ–ΈνΈκ°€ λ„λ¬΄ νΌ

**νλΌλ―Έν„°λ³„ μƒμ„Έ (Iteration #1)**:
```
beta_price        : grad = +448.52
beta_health_label : grad = -258.47
asc_sugar_free    : grad = -228.95
asc_sugar         : grad = -90.64
```

**μ™ μ΄λ ‡κ² ν°κ°€?**

#### μ„ νƒλ¨λΈ κ·Έλλ””μ–ΈνΈ κ³µμ‹
```
β‚ log L / β‚Ξ² = Ξ£_situations sign Γ— mills_ratio Γ— X

μ—¬κΈ°μ„:
- sign = +1 (choice=1) or -1 (choice=0)
- mills_ratio = Ο†(V) / Ξ¦(V) λλ” Ο†(V) / (1-Ξ¦(V))
- X: μ„ νƒ μ†μ„± κ°’
```

**λ¬Έμ μ **:
1. **μ—¬λ¬ μ„ νƒ μƒν™© ν•©μ‚°**
   - κ°μΈλ‹Ή μ„ νƒ μƒν™© μ: ν‰κ·  ~10κ°
   - **gradient = Ξ£_situations (...)** β† 10λ°° μ¦ν­!

2. **Mills ratioκ°€ ν΄ μ μμ**
   - Vκ°€ 0 κ·Όμ²μΌ λ•: mills_ratio β‰ 0.8
   - Vκ°€ κ·Ήλ‹¨μ μΌ λ•: mills_ratio > 10
   - **ν‰κ·  mills_ratio β‰ 1 ~ 5**

3. **μ†μ„± κ°’μ΄ ν‘μ¤€ν™”λμ§€ μ•μ**
   - price: μ›λ κ°’ (μ: 1000, 2000, ...)
   - health_label: 0 λλ” 1
   - **X κ°’μ΄ ν¬λ©΄ gradientλ„ νΌ**

4. **Importance weighting ν¨κ³Ό**
   - κµ¬μ΅°λ¨λΈκ³Ό λ‹¬λ¦¬ μƒμ‡„λμ§€ μ•μ
   - λ¨λ“  situationsμ—μ„ κ°™μ€ λ°©ν–¥μΌλ΅ λ„μ 

**κ²°κ³Ό**:
```
gradient β‰ 10 situations Γ— 5 mills_ratio Γ— 10 X_value β‰ 500
```

---

## π― κ·Όλ³Έ μ›μΈ μ”μ•½

| μ”μΈ | κµ¬μ΅°λ¨λΈ | μ„ νƒλ¨λΈ | λΉ„μ¨ |
|------|---------|---------|------|
| **λ°μ΄ν„° μ¤μΌ€μΌ** | ν‘μ¤€ν™” (Β±3) | μ›λ κ°’ (Β±1000) | 1 : 300 |
| **ν•©μ‚° λ²”μ„** | 1κ° (κ°μΈ) | 10κ° (μ„ νƒ μƒν™©) | 1 : 10 |
| **Mills ratio** | N/A | 1 ~ 5 | 1 : 3 |
| **μƒμ‡„ ν¨κ³Ό** | μμ (Β±) | μ—†μ (λ„μ ) | 1 : 2 |
| **π”΄ Predictor κ°’** | **κ±°μ 0** | N/A | **1 : β** |
| **μ΄ λΉ„μ¨** | 1 | **10,000** | **1 : 10,000** |

### π› μ¶”κ°€ λ°κ²¬: κµ¬μ΅°λ¨λΈ κ·Έλλ””μ–ΈνΈ κ³ μ • λ²„κ·Έ

**`gamma_health_concern_to_perceived_benefit`μ κ·Έλλ””μ–ΈνΈκ°€ λ¨λ“  iterationμ—μ„ λ™μΌ**:
- Iteration #1: -0.041543370
- Iteration #2: -0.041543370
- Iteration #3: -0.041543370
- ...
- Iteration #9: -0.041543370

**μ›μΈ**: `health_concern` β†’ `perceived_benefit` κ²½λ΅μ predictor κ°’μ΄ κ±°μ 0μ— κ°€κΉμ›μ„, νλΌλ―Έν„°κ°€ λ³€ν•΄λ„ κ·Έλλ””μ–ΈνΈκ°€ λ³€ν•μ§€ μ•μ

**μν–¥**: μ΄ νλΌλ―Έν„°λ” μµμ ν™”λμ§€ μ•μ β†’ κµ¬μ΅°λ¨λΈ μ „μ²΄κ°€ μ λ€λ΅ μ¶”μ •λμ§€ μ•μ

---

## π’΅ ν•΄κ²° λ°©μ•

### π¥‡ 1μμ„: νλΌλ―Έν„° μ¤μΌ€μΌλ§ ν™μ„±ν™”

```python
config.estimation.use_parameter_scaling = True
```

**ν¨κ³Ό**:
- κ° νλΌλ―Έν„°λ¥Ό μμ‹ μ μ „ν•μ μΈ ν¬κΈ°λ΅ λ‚λ”
- κ·Έλλ””μ–ΈνΈ ν¬κΈ°λ¥Ό κ· λ“±ν•κ² λ§λ“¦
- L-BFGS-Bμ Hessian κ·Όμ‚¬κ°€ μ•μ •ν™”λ¨

**μμƒ κ²°κ³Ό**:
```
# μ¤μΌ€μΌλ§ μ „
grad_gamma = 0.026
grad_beta = 256.66
λΉ„μ¨ = 9,836x

# μ¤μΌ€μΌλ§ ν›„
grad_gamma_scaled = 0.026 / 0.1 = 0.26
grad_beta_scaled = 256.66 / 100 = 2.57
λΉ„μ¨ = 10x (ν—μ© λ²”μ„)
```

---

### π¥ 2μμ„: μ΄κΈ°κ°’ κ°μ„ 

**ν„μ¬ λ¬Έμ **:
- λ¨λ“  νλΌλ―Έν„° μ΄κΈ°κ°’ = 0.1 (λ™μΌ)
- μ„ νƒλ¨λΈ νλΌλ―Έν„°λ” λ” ν° μ΄κΈ°κ°’μ΄ ν•„μ”

**ν•΄κ²°μ±…**:
```python
# μμ°¨μ¶”μ • κ²°κ³Ό μ‚¬μ©
initial_params = {
    'gamma_*': 0.1,  # κµ¬μ΅°λ¨λΈ (μ‘μ€ κ°’)
    'beta_*': 1.0,   # μ„ νƒλ¨λΈ (ν° κ°’)
    'asc_*': 0.5,    # μ νΈ (μ¤‘κ°„ κ°’)
    'theta_*': 0.5   # LV κ³„μ (μ¤‘κ°„ κ°’)
}
```

---

### π¥‰ 3μμ„: μ„ νƒ μ†μ„± ν‘μ¤€ν™”

**ν„μ¬ λ¬Έμ **:
- price: 1000 ~ 5000 (ν‘μ¤€ν™” μ• λ¨)
- health_label: 0 ~ 1 (ν‘μ¤€ν™” μ• λ¨)

**ν•΄κ²°μ±…**:
```python
# λ°μ΄ν„° μ „μ²λ¦¬ μ‹
data['price_std'] = (data['price'] - mean) / std
data['health_label_std'] = data['health_label']  # μ΄λ―Έ 0-1
```

**ν¨κ³Ό**:
- μ„ νƒλ¨λΈ κ·Έλλ””μ–ΈνΈ ν¬κΈ° κ°μ†
- κµ¬μ΅°λ¨λΈκ³Ό λΉ„μ·ν• μ¤μΌ€μΌ

---

## π“ κ¶μ¥ μ΅°μΉ

### μ¦‰μ‹ μ‹¤ν–‰

1. β… **νλΌλ―Έν„° μ¤μΌ€μΌλ§ ν™μ„±ν™”**
   ```python
   config.estimation.use_parameter_scaling = True
   ```

2. β… **Hessian μ£ΌκΈ°μ  λ¦¬μ…‹**
   ```python
   config.estimation.reset_hessian_every = 10
   ```

### μ¶”κ°€ κ°μ„  (μ„ νƒ)

3. β οΈ **μμ°¨μ¶”μ • κ²°κ³Όλ΅ μ΄κΈ°κ°’ μ„¤μ •**
4. β οΈ **μ„ νƒ μ†μ„± ν‘μ¤€ν™”**

---

## π“ μμƒ ν¨κ³Ό

### μ¤μΌ€μΌλ§ μ „ (ν„μ¬)
```
Iteration #1:
  y_k/s_k = 690.2 (κ·Ήλ‹¨μ )
  νƒμƒ‰ λ°©ν–¥ = 0 (Iteration #2λ¶€ν„°)
  μµμ ν™” μ¤‘λ‹¨
```

### μ¤μΌ€μΌλ§ ν›„ (μμƒ)
```
Iteration #1:
  y_k/s_k = 10 ~ 50 (μ •μƒ)
  νƒμƒ‰ λ°©ν–¥ β‰  0
  μµμ ν™” κ³„μ† μ§„ν–‰
  μλ ΄ μ„±κ³µ
```

---

## π”— κ΄€λ ¨ νμΌ

- **λ΅κ·Έ νμΌ**: `results/simultaneous_estimation_log_20251120_192842.txt`
- **λ¶„μ„ μ¤ν¬λ¦½νΈ**:
  - `scripts/analyze_gradient_magnitude_issue.py` - κ·Έλλ””μ–ΈνΈ ν¬κΈ° λ¶„μ„
  - `scripts/check_structural_gradient_frozen.py` - κµ¬μ΅°λ¨λΈ κ·Έλλ””μ–ΈνΈ κ³ μ • ν™•μΈ
- **Hessian μ§„λ‹¨**: `results/HESSIAN_CONVERGENCE_ISSUE_REPORT_20251120.md`
- **μ½”λ“ λ¦¬λ·°**: `results/CODE_REVIEW_HESSIAN_HANDLING_20251120.md`
- **λ²„κ·Έ μ„μΉ**: `src/analysis/hybrid_choice_model/iclv_models/gpu_gradient_batch.py:1586-1638`

---

## π¨ μµμΆ… κ²°λ΅ 

### λ‘ κ°€μ§€ λ…λ¦½μ μΈ λ¬Έμ  λ°κ²¬

#### 1οΈβƒ£ κ·Έλλ””μ–ΈνΈ ν¬κΈ° λ¶κ· ν• (μ£Ό λ¬Έμ )
- **μ„ νƒλ¨λΈ κ·Έλλ””μ–ΈνΈκ°€ κµ¬μ΅°λ¨λΈλ³΄λ‹¤ 10,000λ°° νΌ**
- **μ›μΈ**: λ°μ΄ν„° μ¤μΌ€μΌ, ν•©μ‚° λ²”μ„, Mills ratio μ°¨μ΄
- **ν•΄κ²°μ±…**: νλΌλ―Έν„° μ¤μΌ€μΌλ§ ν™μ„±ν™”

#### 2οΈβƒ£ κµ¬μ΅°λ¨λΈ κ·Έλλ””μ–ΈνΈ κ³ μ • λ²„κ·Έ (λ¶€μ°¨ λ¬Έμ )
- **`gamma_health_concern_to_perceived_benefit`μ κ·Έλλ””μ–ΈνΈκ°€ μ™„μ „ν κ³ μ •**
- **μ›μΈ**: Predictor κ°’μ΄ κ±°μ 0μ— κ°€κΉμ›€
- **ν•΄κ²°μ±…**:
  1. λ°μ΄ν„° ν™•μΈ (health_concern κ°’μ΄ μ λ€λ΅ μƒμ„±λλ”μ§€)
  2. μ΄κΈ°κ°’ κ°μ„  (λ” ν° μ΄κΈ°κ°’ μ‚¬μ©)
  3. κµ¬μ΅°λ¨λΈ μ„¤μ • κ²€ν†  (κ²½λ΅κ°€ μ¬λ°”λ¥Έμ§€)

### μ°μ„ μμ„

1. **μ¦‰μ‹ μ‹¤ν–‰**: νλΌλ―Έν„° μ¤μΌ€μΌλ§ ν™μ„±ν™” (λ¬Έμ  1 ν•΄κ²°)
2. **μ¶”κ°€ μ΅°μ‚¬**: κµ¬μ΅°λ¨λΈ λ°μ΄ν„° λ° μ„¤μ • ν™•μΈ (λ¬Έμ  2 ν•΄κ²°)
3. **μ¥κΈ° κ°μ„ **: μ„ νƒ μ†μ„± ν‘μ¤€ν™”, μ΄κΈ°κ°’ κ°μ„ 

