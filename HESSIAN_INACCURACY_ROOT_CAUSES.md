# Hessian ê·¼ì‚¬ ë¶€ì •í™• ì›ì¸ ë¶„ì„

**ë‚ ì§œ**: 2025-11-23  
**ë¶„ì„ ëŒ€ìƒ**: ë™ì‹œì¶”ì • ìˆ˜ë ´ ì‹¤íŒ¨ (ë¡œê·¸: `simultaneous_estimation_log_20251123_114842.txt`)

---

## ğŸ“‹ ìš”ì•½

L-BFGS-Bì˜ Hessian ê·¼ì‚¬ê°€ ë¶€ì •í™•í•œ **ê·¼ë³¸ ì›ì¸**ì„ ë¶„ì„í•œ ê²°ê³¼, **5ê°€ì§€ ì£¼ìš” ì›ì¸**ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ”´ ì›ì¸ 1: íƒìƒ‰ ë°©í–¥ì´ 0ì´ ë˜ëŠ” í˜„ìƒ (ê°€ì¥ ì‹¬ê°)

### **ì¦ê±°**

ë¡œê·¸ íŒŒì¼ì—ì„œ **Iteration #3-11**ê¹Œì§€ **íƒìƒ‰ ë°©í–¥ d = 0**ì´ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒ:

| Iteration | íƒìƒ‰ ë°©í–¥ norm | Gradient norm | ì½”ì‚¬ì¸ ìœ ì‚¬ë„ | ìƒíƒœ |
|-----------|---------------|--------------|-------------|------|
| 3 | **0.000000e+00** | 362.18 | 0.000000 | âŒ ì •ì²´ |
| 4 | **0.000000e+00** | 271.93 | 0.000000 | âŒ ì •ì²´ |
| 5 | **0.000000e+00** | 107.89 | 0.000000 | âŒ ì •ì²´ |
| 6 | **0.000000e+00** | 98.05 | 0.000000 | âŒ ì •ì²´ |
| 7 | **0.000000e+00** | 103.19 | 0.000000 | âŒ ì •ì²´ |
| 8 | **0.000000e+00** | 115.35 | 0.000000 | âŒ ì •ì²´ |
| 9 | **0.000000e+00** | 78.43 | 0.000000 | âŒ ì •ì²´ |
| 10 | **0.000000e+00** | 3.81 | 0.000000 | âŒ ì •ì²´ |
| 11 | **0.000000e+00** | 3.81 | 0.000000 | âŒ ì •ì²´ |

**ê´€ì°°**:
- Gradient normì€ 3.81 ~ 362.18 (0ì´ ì•„ë‹˜)
- í•˜ì§€ë§Œ íƒìƒ‰ ë°©í–¥ d = 0 (ì™„ì „íˆ 0)
- **L-BFGS-Bê°€ íƒìƒ‰ ë°©í–¥ì„ ê³„ì‚°í•˜ì§€ ëª»í•¨**

---

### **ì›ì¸: L-BFGS-Bì˜ Two-loop Recursion ì‹¤íŒ¨**

L-BFGS-BëŠ” ë‹¤ìŒ ê³µì‹ìœ¼ë¡œ íƒìƒ‰ ë°©í–¥ì„ ê³„ì‚°:

```
d = -H^(-1) Â· g
```

ì—¬ê¸°ì„œ `H^(-1)`ì€ (s, y) ìŒìœ¼ë¡œë¶€í„° ì•”ë¬µì ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.

**Two-loop recursion ì•Œê³ ë¦¬ì¦˜**:

```python
# L-BFGS-Bì˜ íƒìƒ‰ ë°©í–¥ ê³„ì‚°
def two_loop_recursion(s_history, y_history, g):
    """
    H^(-1) Â· gë¥¼ ì•”ë¬µì ìœ¼ë¡œ ê³„ì‚°
    
    s_history: ìµœê·¼ mê°œì˜ íŒŒë¼ë¯¸í„° ë³€í™” (x_new - x)
    y_history: ìµœê·¼ mê°œì˜ gradient ë³€í™” (g_new - g)
    g: í˜„ì¬ gradient
    """
    q = g.copy()
    m = len(s_history)
    alpha = np.zeros(m)
    rho = np.zeros(m)
    
    # First loop (backward)
    for i in range(m-1, -1, -1):
        rho[i] = 1.0 / (y_history[i] @ s_history[i])  # âš ï¸ ë¬¸ì œ ë°œìƒ ì§€ì 
        alpha[i] = rho[i] * (s_history[i] @ q)
        q = q - alpha[i] * y_history[i]
    
    # Scaling
    if m > 0:
        gamma = (s_history[-1] @ y_history[-1]) / (y_history[-1] @ y_history[-1])
        r = gamma * q
    else:
        r = q
    
    # Second loop (forward)
    for i in range(m):
        beta = rho[i] * (y_history[i] @ r)
        r = r + s_history[i] * (alpha[i] - beta)
    
    return -r  # íƒìƒ‰ ë°©í–¥
```

**ë¬¸ì œ ë°œìƒ ì¡°ê±´**:

1. **`y @ s â‰ˆ 0`ì¸ ê²½ìš°**: `rho = 1/(y @ s)` â†’ ë¬´í•œëŒ€
2. **`y @ s < 0`ì¸ ê²½ìš°**: Curvature ì¡°ê±´ ìœ„ë°˜ (ì´ë¡ ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ ìˆ˜ì¹˜ ì˜¤ì°¨ë¡œ ë°œìƒ ê°€ëŠ¥)
3. **`s â‰ˆ 0`ì¸ ê²½ìš°**: íŒŒë¼ë¯¸í„° ë³€í™”ê°€ ê±°ì˜ ì—†ìŒ (Line Search ì‹¤íŒ¨ ì‹œ)

**ê²°ê³¼**: `d = 0` (íƒìƒ‰ ë°©í–¥ì´ 0ì´ ë¨)

---

## ğŸ”´ ì›ì¸ 2: Gradient í¬ê¸° ë¶ˆê· í˜• (Scale Mismatch)

### **ì¦ê±°**

ë¡œê·¸ íŒŒì¼ì—ì„œ Gradient í¬ê¸°ê°€ ë§¤ìš° ë¶ˆê· í˜•:

| Iteration | Gradient norm | Gradient ìƒìœ„ 5ê°œ ê°’ | ë¹„ìœ¨ |
|-----------|--------------|---------------------|------|
| 1 | 762.33 | [-336.30, -384.75, 91.13, 242.84, 122.86] | **ìµœëŒ€/ìµœì†Œ = 4.2ë°°** |
| 2 | 538.64 | [167.31, 279.10, 103.52, 192.44, 148.87] | **ìµœëŒ€/ìµœì†Œ = 2.7ë°°** |
| 3 | 362.18 | [157.70, 155.25, 164.26, 45.06, 159.72] | **ìµœëŒ€/ìµœì†Œ = 3.6ë°°** |
| 11 | 3.81 | [-2.06, 1.76, -0.06, -0.86, -0.20] | **ìµœëŒ€/ìµœì†Œ = 34.3ë°°** |

**ê´€ì°°**:
- Gradient ì„±ë¶„ ê°„ í¬ê¸° ì°¨ì´ê°€ ìµœëŒ€ **34ë°°**
- ì¼ë¶€ íŒŒë¼ë¯¸í„°ëŠ” gradientê°€ ë§¤ìš° í¬ê³ , ì¼ë¶€ëŠ” ë§¤ìš° ì‘ìŒ

---

### **ì›ì¸: íŒŒë¼ë¯¸í„° ìŠ¤ì¼€ì¼ ë¶ˆê· í˜•**

í˜„ì¬ ì„¤ì •:
```python
use_parameter_scaling = False  # âŒ ìŠ¤ì¼€ì¼ë§ ë¹„í™œì„±í™”
```

**ë¬¸ì œ**:
- ì¸¡ì •ëª¨ë¸ íŒŒë¼ë¯¸í„° (zeta, sigma_sq): í¬ê¸° ~0.1-1.0
- êµ¬ì¡°ëª¨ë¸ íŒŒë¼ë¯¸í„° (gamma): í¬ê¸° ~0.001-0.1
- ì„ íƒëª¨ë¸ íŒŒë¼ë¯¸í„° (asc, beta, theta): í¬ê¸° ~0.1-2.0

**ê²°ê³¼**:
- Gradient í¬ê¸°ê°€ íŒŒë¼ë¯¸í„° ìŠ¤ì¼€ì¼ì— ë¹„ë¡€í•˜ì—¬ ë¶ˆê· í˜•
- L-BFGS-Bì˜ Hessian ê·¼ì‚¬ê°€ ë¶€ì •í™•í•´ì§
- **ì¼ë¶€ íŒŒë¼ë¯¸í„°ëŠ” ê³¼ë„í•˜ê²Œ ì—…ë°ì´íŠ¸ë˜ê³ , ì¼ë¶€ëŠ” ê±°ì˜ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ**

---

## ğŸ”´ ì›ì¸ 3: íƒìƒ‰ ë°©í–¥ê³¼ Gradientì˜ ë°©í–¥ ë¶ˆì¼ì¹˜

### **ì¦ê±°**

ë¡œê·¸ íŒŒì¼ì—ì„œ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ë¶„ì„:

| Iteration | ì½”ì‚¬ì¸ ìœ ì‚¬ë„ | í•´ì„ |
|-----------|-------------|------|
| 1 | **0.302** | ì•½í•œ ì–‘ì˜ ìƒê´€ (30% ì¼ì¹˜) |
| 2 | **-0.106** | ì•½í•œ ìŒì˜ ìƒê´€ (ë°˜ëŒ€ ë°©í–¥!) |
| 5 | **0.022** | ê±°ì˜ ì§êµ (2% ì¼ì¹˜) |
| 12 | **-0.465** | ì¤‘ê°„ ìŒì˜ ìƒê´€ (ë°˜ëŒ€ ë°©í–¥!) |

**ì´ìƒì ì¸ ê°’**: **1.0** (ì™„ì „íˆ ë™ì¼í•œ ë°©í–¥, H = Iì¸ ê²½ìš°)

**ê´€ì°°**:
- ì½”ì‚¬ì¸ ìœ ì‚¬ë„ê°€ **-0.465 ~ 0.302** (ë§¤ìš° ë‚®ìŒ)
- ì¼ë¶€ iterationì—ì„œëŠ” **ìŒìˆ˜** (íƒìƒ‰ ë°©í–¥ì´ gradientì™€ ë°˜ëŒ€!)
- **Hessian ê·¼ì‚¬ê°€ ë§¤ìš° ë¶€ì •í™•í•¨ì„ ì‹œì‚¬**

---

### **ì›ì¸: Hessian ê·¼ì‚¬ì˜ ëˆ„ì  ì˜¤ì°¨**

L-BFGS-BëŠ” ìµœê·¼ **m=10ê°œ**ì˜ (s, y) ìŒë§Œ ì €ì¥:

```python
m = 10  # Limited memory
s_history = []  # ìµœê·¼ 10ê°œì˜ íŒŒë¼ë¯¸í„° ë³€í™”
y_history = []  # ìµœê·¼ 10ê°œì˜ gradient ë³€í™”
```

**ë¬¸ì œ**:
1. **ì´ˆê¸° iterations**: (s, y) ìŒì´ ë¶€ì¡±í•˜ì—¬ Hessian ê·¼ì‚¬ê°€ ë¶€ì •í™•
2. **ì¤‘ê°„ iterations**: Line Search ì‹¤íŒ¨ë¡œ `s â‰ˆ 0` â†’ ì˜ëª»ëœ (s, y) ìŒ ì €ì¥
3. **í›„ê¸° iterations**: ëˆ„ì ëœ ì˜¤ì°¨ë¡œ Hessian ê·¼ì‚¬ê°€ ì ì  ë” ë¶€ì •í™•í•´ì§

**ê²°ê³¼**:
- íƒìƒ‰ ë°©í–¥ì´ gradientì™€ ì§êµí•˜ê±°ë‚˜ ë°˜ëŒ€ ë°©í–¥
- Line Searchê°€ ì ì ˆí•œ step sizeë¥¼ ì°¾ì§€ ëª»í•¨
- **ìˆ˜ë ´ ì‹¤íŒ¨**

---

## ğŸ”´ ì›ì¸ 4: Line Search ì‹¤íŒ¨ë¡œ ì¸í•œ ì˜ëª»ëœ (s, y) ìŒ ì €ì¥

### **ì¦ê±°**

Line Search íŒ¨í„´ ë¶„ì„ ê²°ê³¼:

| Phase | ì‹œë„ | íŒŒë¼ë¯¸í„° ë³€í™” | LL ë³€í™” | ìƒíƒœ |
|-------|------|--------------|---------|------|
| Phase 1 | 1-10 | 0.000 â†’ 0.0066 | +0.000 â†’ +0.0135 | ìˆ˜ë ´ |
| Phase 2 | 11-19 | **0.0066** (ë™ì¼) | **+0.0135** (ë™ì¼) | **ì •ì²´** |
| Phase 3 | 20 | **3.775** (568ë°°!) | **-2675** (ëŒ€í­ ì•…í™”) | **ì‹¤íŒ¨** |

**ê´€ì°°**:
- Phase 2: 9íšŒ ì—°ì† ë™ì¼í•œ ê²°ê³¼ â†’ Line Search ì •ì²´
- Phase 3: í° step size ì‹œë„ â†’ LL ëŒ€í­ ì•…í™”

---

### **ì›ì¸: Wolfe ì¡°ê±´ ë¶ˆë§Œì¡±**

Line SearchëŠ” ë‹¤ìŒ Wolfe ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” step size Î±ë¥¼ ì°¾ì•„ì•¼ í•¨:

1. **Sufficient decrease (Armijo ì¡°ê±´)**:
   ```
   f(x + Î±Â·d) â‰¤ f(x) + c1Â·Î±Â·(g^TÂ·d)
   ```
   ì—¬ê¸°ì„œ `c1 = 1e-4` (ê¸°ë³¸ê°’)

2. **Curvature ì¡°ê±´**:
   ```
   |g(x + Î±Â·d)^TÂ·d| â‰¤ c2Â·|g(x)^TÂ·d|
   ```
   ì—¬ê¸°ì„œ `c2 = 0.9` (ê¸°ë³¸ê°’)

**ë¬¸ì œ**:
- íƒìƒ‰ ë°©í–¥ dê°€ ì˜ëª»ë˜ë©´ (ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ë‚®ìŒ) Wolfe ì¡°ê±´ì„ ë§Œì¡±í•˜ê¸° ì–´ë ¤ì›€
- Line Searchê°€ maxls=10ì— ë„ë‹¬í•´ë„ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ëª»í•¨
- **ì˜ëª»ëœ step sizeë¡œ íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸**

**ê²°ê³¼**:
- ì˜ëª»ëœ (s, y) ìŒì´ L-BFGS-B ë©”ëª¨ë¦¬ì— ì €ì¥ë¨
- ë‹¤ìŒ iterationì˜ Hessian ê·¼ì‚¬ê°€ ë”ìš± ë¶€ì •í™•í•´ì§
- **ì•…ìˆœí™˜ (Vicious cycle)**

---

## ğŸ”´ ì›ì¸ 5: í‰íƒ„í•œ í•¨ìˆ˜ ì˜ì—­ (Flat Region)

### **ì¦ê±°**

LL ë³€í™” ì¶”ì´:

| Iteration | LL | LL ë³€í™” | ë³€í™”ìœ¨ |
|-----------|-----|---------|--------|
| 1-4 | -2416 â†’ -2124 | í‰ê·  97.64 | 4% ì´ìƒ |
| 7-11 | -2088 â†’ -2052 | í‰ê·  9.58 | **1% ë¯¸ë§Œ** |
| 10-11 | -2054 â†’ -2052 | **1.87** | **0.09%** |

**ê´€ì°°**:
- ì´ˆê¸°: ë¹ ë¥¸ ê°œì„  (4% ì´ìƒ)
- í›„ê¸°: ë§¤ìš° ëŠë¦° ê°œì„  (0.09%)
- **í•¨ìˆ˜ê°€ í‰íƒ„í•œ ì˜ì—­ì— ë„ë‹¬**

---

### **ì›ì¸: Local Minimum ë˜ëŠ” Saddle Point**

**ê°€ëŠ¥ì„± 1: Local Minimum**
- í˜„ì¬ LL = -2052.46ì´ local minimum
- Gradientê°€ 0ì— ê°€ê¹Œì›Œì§ (norm = 3.81)
- í•˜ì§€ë§Œ gtol ê¸°ì¤€(1e-3)ì„ ë§Œì¡±í•˜ì§€ ëª»í•¨ (2.29)

**ê°€ëŠ¥ì„± 2: Saddle Point**
- ì¼ë¶€ ë°©í–¥ìœ¼ë¡œëŠ” ìµœì†Œ, ì¼ë¶€ ë°©í–¥ìœ¼ë¡œëŠ” ìµœëŒ€
- Hessianì˜ ì¼ë¶€ eigenvalueê°€ ìŒìˆ˜
- L-BFGS-Bê°€ íƒìƒ‰ ë°©í–¥ì„ ì°¾ì§€ ëª»í•¨

**ê°€ëŠ¥ì„± 3: í‰íƒ„í•œ ì˜ì—­ (Plateau)**
- í•¨ìˆ˜ê°€ ê±°ì˜ í‰í‰í•œ ì˜ì—­
- Gradientê°€ ì‘ì§€ë§Œ 0ì€ ì•„ë‹˜
- ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ì´ë™í•´ë„ LL ê°œì„ ì´ ë¯¸ë¯¸

---

## ğŸ“Š ì¢…í•© ë¶„ì„: 5ê°€ì§€ ì›ì¸ì˜ ìƒí˜¸ì‘ìš©

```
[ì´ˆê¸°ê°’ ë¶€ì ì ˆ]
    â†“
[íŒŒë¼ë¯¸í„° ìŠ¤ì¼€ì¼ ë¶ˆê· í˜•] â†’ [Gradient í¬ê¸° ë¶ˆê· í˜•]
    â†“                           â†“
[L-BFGS-B Hessian ê·¼ì‚¬ ë¶€ì •í™•]
    â†“
[íƒìƒ‰ ë°©í–¥ê³¼ Gradient ë°©í–¥ ë¶ˆì¼ì¹˜]
    â†“
[Line Search ì‹¤íŒ¨ (Wolfe ì¡°ê±´ ë¶ˆë§Œì¡±)]
    â†“
[ì˜ëª»ëœ (s, y) ìŒ ì €ì¥]
    â†“
[Hessian ê·¼ì‚¬ ë”ìš± ë¶€ì •í™•] â† ì•…ìˆœí™˜
    â†“
[íƒìƒ‰ ë°©í–¥ d = 0]
    â†“
[í‰íƒ„í•œ ì˜ì—­ì—ì„œ ì •ì²´]
    â†“
[ìˆ˜ë ´ ì‹¤íŒ¨]
```

---

## ğŸ’¡ í•´ê²° ë°©ì•ˆ

### **[HIGH] 1. íŒŒë¼ë¯¸í„° ìŠ¤ì¼€ì¼ë§ í™œì„±í™”**

```python
use_parameter_scaling = True  # âŒ False â†’ âœ… True
```

**íš¨ê³¼**:
- Gradient í¬ê¸° ê· í˜• ê°œì„ 
- Hessian ê·¼ì‚¬ ì •í™•ë„ í–¥ìƒ
- Line Search ì„±ê³µë¥  ì¦ê°€

---

### **[HIGH] 2. ì´ˆê¸°ê°’ ê°œì„ **

**í˜„ì¬**: ëª¨ë“  íŒŒë¼ë¯¸í„°ë¥¼ 0.1ë¡œ ì´ˆê¸°í™”

**ì œì•ˆ**: ìˆœì°¨ì¶”ì • 2ë‹¨ê³„ ê²°ê³¼ë¥¼ ì •í™•í•˜ê²Œ ì‚¬ìš©

```python
# st2_HC-PB_PB-PI1_PI2_results.csvì—ì„œ ì¶”ì •ê°’ ë¡œë“œ
stage2_results = pd.read_csv('results/final/sequential/stage2/st2_HC-PB_PB-PI1_PI2_results.csv')
initial_params = extract_initial_values_from_stage2(stage2_results)
```

**íš¨ê³¼**:
- ë” ë‚˜ì€ ì´ˆê¸° Hessian ê·¼ì‚¬
- ë¹ ë¥¸ ìˆ˜ë ´
- ë‹¤ë¥¸ local minimum íƒìƒ‰ ê°€ëŠ¥

---

### **[MEDIUM] 3. Trust Region ì•Œê³ ë¦¬ì¦˜ ì‹œë„**

```python
optimizer = 'trust-constr'  # L-BFGS-B â†’ trust-constr
```

**ì´ìœ **:
- Trust Regionì€ Hessian ê·¼ì‚¬ê°€ ë¶€ì •í™•í•  ë•Œ ë” robust
- íŒŒë¼ë¯¸í„° ë³€í™”ë¥¼ ì œí•œí•˜ì—¬ ì•ˆì •ì„± í–¥ìƒ
- í‰íƒ„í•œ ì˜ì—­ì—ì„œ ë” íš¨ê³¼ì 

---

### **[LOW] 4. Hessian ì£¼ê¸°ì  ë¦¬ì…‹**

```python
# 10 iterationsë§ˆë‹¤ Hessianì„ ì´ˆê¸°ê°’(I)ìœ¼ë¡œ ë¦¬ì…‹
# (L-BFGS-BëŠ” scipyì—ì„œ ì§ì ‘ ì œì–´ ë¶ˆê°€, ì»¤ìŠ¤í…€ êµ¬í˜„ í•„ìš”)
```

**íš¨ê³¼**:
- ëˆ„ì ëœ Hessian ì˜¤ì°¨ ì œê±°
- ìƒˆë¡œìš´ íƒìƒ‰ ë°©í–¥ ì‹œë„

---

## ğŸ“‹ ê²°ë¡ 

### **Hessian ê·¼ì‚¬ê°€ ë¶€ì •í™•í•œ ê·¼ë³¸ ì›ì¸**

1. âœ… **íŒŒë¼ë¯¸í„° ìŠ¤ì¼€ì¼ ë¶ˆê· í˜•** â†’ Gradient í¬ê¸° ë¶ˆê· í˜• â†’ Hessian ê·¼ì‚¬ ë¶€ì •í™•
2. âœ… **ì´ˆê¸°ê°’ ë¶€ì ì ˆ** â†’ ì´ˆê¸° Hessian ê·¼ì‚¬ ë¶€ì •í™• â†’ ëˆ„ì  ì˜¤ì°¨
3. âœ… **Line Search ì‹¤íŒ¨** â†’ ì˜ëª»ëœ (s, y) ìŒ ì €ì¥ â†’ Hessian ê·¼ì‚¬ ì•…í™”
4. âœ… **í‰íƒ„í•œ í•¨ìˆ˜ ì˜ì—­** â†’ íƒìƒ‰ ë°©í–¥ ê³„ì‚° ì–´ë ¤ì›€
5. âœ… **L-BFGS-Bì˜ Limited Memory** â†’ ì˜¤ë˜ëœ ì •ë³´ ì†ì‹¤ â†’ ê·¼ì‚¬ ë¶€ì •í™•

### **ê°€ì¥ íš¨ê³¼ì ì¸ í•´ê²°ì±…**

1. **íŒŒë¼ë¯¸í„° ìŠ¤ì¼€ì¼ë§ í™œì„±í™”** (ì¦‰ì‹œ ì‹œë„ ê°€ëŠ¥)
2. **ì´ˆê¸°ê°’ ê°œì„ ** (ìˆœì°¨ì¶”ì • 2ë‹¨ê³„ ê²°ê³¼ ì‚¬ìš©)
3. **Trust Region ì•Œê³ ë¦¬ì¦˜ ì‹œë„** (L-BFGS-B ëŒ€ì•ˆ)

---

**ë¶„ì„ ì™„ë£Œ ì¼ì‹œ**: 2025-11-23

