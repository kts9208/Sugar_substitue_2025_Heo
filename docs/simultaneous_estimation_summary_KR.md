# λ™μ‹μ¶”μ • μ½”λ“ μ”μ•½ μ„¤λ… (ν•κµ­μ–΄)

## π“ ν•µμ‹¬ μ”μ•½

### λ™μ‹μ¶”μ •μ΄λ€?
```
β… μΈ΅μ •λ¨λΈ νλΌλ―Έν„°: CFA κ²°κ³Όλ΅ κ³ μ • (μ¶”μ • μ• ν•¨)
β… κµ¬μ΅°λ¨λΈ + μ„ νƒλ¨λΈ: λ™μ‹μ— μ¶”μ •
```

---

## 1. νλΌλ―Έν„° κ³„μ‚° λ΅μ§

### 1.1 νλΌλ―Έν„° 3κ°€μ§€ κ·Έλ£Ή

| λ¨λΈ | νλΌλ―Έν„° | μ΄κΈ°κ°’ | μ¶”μ • μ—¬λ¶€ |
|------|---------|--------|----------|
| **μΈ΅μ •λ¨λΈ** | zeta (μ”μΈμ μ¬λ‰)<br/>sigma_sq (μ¤μ°¨λ¶„μ‚°)<br/>alpha (μ νΈ) | CFA κ²°κ³Ό | β κ³ μ • |
| **κµ¬μ΅°λ¨λΈ** | gamma (κ²½λ΅κ³„μ)<br/>μ: gamma_HC_to_PB | 0.1 | β… μ¶”μ • |
| **μ„ νƒλ¨λΈ** | asc (λ€μ•μƒμ)<br/>beta (μ†μ„±κ³„μ)<br/>theta (LVκ³„μ)<br/>gamma (μƒνΈμ‘μ©) | 0.1 | β… μ¶”μ • |

### 1.2 μ΄κΈ°ν™” κ³Όμ •

#### Step 1: μΈ΅μ •λ¨λΈ (CFA κ²°κ³Ό λ΅λ“)
```python
# cfa_results.pklμ—μ„ λ΅λ“
for lv_name in ['HC', 'PB', 'PP', 'NK', 'PI']:
    model.config.zeta = CFAμ—μ„_μ¶”μ¶ν•_μ”μΈμ μ¬λ‰
    model.config.sigma_sq = CFAμ—μ„_μ¶”μ¶ν•_μ¤μ°¨λ¶„μ‚°
    model.config.alpha = CFAμ—μ„_μ¶”μ¶ν•_μ νΈ
```

#### Step 2: κµ¬μ΅°λ¨λΈ (0.1λ΅ μ΄κΈ°ν™”)
```python
# κ²½λ΅: HC β†’ PB β†’ PI
gamma_HC_to_PB = 0.1
gamma_PB_to_PI = 0.1
```

#### Step 3: μ„ νƒλ¨λΈ (0.1λ΅ μ΄κΈ°ν™”)
```python
# λ€μ•λ³„ μƒμ
asc_sugar = 0.1
asc_sugar_free = 0.1

# μ†μ„± κ³„μ
beta_health_label = 0.1
beta_price = 0.1

# LV κ³„μ (λ€μ•λ³„)
theta_sugar_PI = 0.1
theta_sugar_free_PI = 0.1

# μƒνΈμ‘μ© (λ€μ•λ³„)
gamma_sugar_PI_health_label = 0.1
gamma_sugar_free_PI_health_label = 0.1
```

---

## 2. κ·Έλλ””μ–ΈνΈ κ³„μ‚° λ΅μ§

### 2.1 μ „μ²΄ νλ¦„

```
1. κ°μΈλ³„ μ²λ¦¬
   β†“
2. κ° κ°μΈμ λ¨λ“  Halton Draws μ²λ¦¬
   β†“
3. κ° Drawμ—μ„ μ μ¬λ³€μ μμΈ΅ (κµ¬μ΅°λ¨λΈ)
   β†“
4. 3κ°€μ§€ μ°λ„ κ³„μ‚°
   - μΈ΅μ •λ¨λΈ μ°λ„: P(μ§€ν‘ | μ μ¬λ³€μ)
   - μ„ νƒλ¨λΈ μ°λ„: P(μ„ νƒ | μ μ¬λ³€μ)
   - κµ¬μ΅°λ¨λΈ μ°λ„: P(μ μ¬λ³€μ)
   β†“
5. κ²°ν•© μ°λ„ = μΈ΅μ • Γ— μ„ νƒ Γ— κµ¬μ΅°
   β†“
6. Importance Weights κ³„μ‚°
   w_r = exp(LL_r) / Ξ£ exp(LL_r')
   β†“
7. κ°€μ¤‘ν‰κ·  κ·Έλλ””μ–ΈνΈ κ³„μ‚°
   β‚LL/β‚ΞΈ = Ξ£ w_r Γ— β‚LL_r/β‚ΞΈ
   β†“
8. λ¨λ“  κ°μΈμ κ·Έλλ””μ–ΈνΈ ν•©μ‚°
   β†“
9. L-BFGS-B μµμ ν™”κΈ°μ— μ „λ‹¬
```

### 2.2 λ¨λΈλ³„ κ·Έλλ””μ–ΈνΈ

#### μΈ΅μ •λ¨λΈ (κ³ μ •, κ³„μ‚°λ§ ν•¨)
```
β‚LL/β‚Ξ¶_j = Ξ£_r w_r Γ— (I_j - Ξ±_j - Ξ¶_j Γ— Ξ·_r) Γ— Ξ·_r / ΟƒΒ²_j

β‚LL/β‚ΟƒΒ²_j = Ξ£_r w_r Γ— [-1/(2ΟƒΒ²_j) + (I_j - Ξ±_j - Ξ¶_j Γ— Ξ·_r)Β² / (2Οƒβ΄_j)]
```

#### κµ¬μ΅°λ¨λΈ (μ¶”μ • λ€μƒ)
```
β‚LL/β‚Ξ³_HC_to_PB = Ξ£_r w_r Γ— [
    β‚P(μ§€ν‘|PB)/β‚PB Γ— β‚PB/β‚Ξ³ +
    β‚P(μ„ νƒ|PB)/β‚PB Γ— β‚PB/β‚Ξ³ +
    β‚P(PB)/β‚Ξ³
]

μ—¬κΈ°μ„:
β‚PB/β‚Ξ³_HC_to_PB = HC (μμΈ΅λ³€μ κ°’)
```

#### μ„ νƒλ¨λΈ (μ¶”μ • λ€μƒ)
```
Multinomial Logit κ·Έλλ””μ–ΈνΈ:

β‚LL/β‚asc_j = Ξ£_r w_r Γ— Ξ£_t [(y_t == j) - P(j|Ξ·_r)]

β‚LL/β‚Ξ²_attr = Ξ£_r w_r Γ— Ξ£_t Ξ£_j [(y_t == j) - P(j|Ξ·_r)] Γ— x_attr

β‚LL/β‚ΞΈ_j_LV = Ξ£_r w_r Γ— Ξ£_t [(y_t == j) - P(j|Ξ·_r)] Γ— Ξ·_r[LV]

β‚LL/β‚Ξ³_j_LV_attr = Ξ£_r w_r Γ— Ξ£_t [(y_t == j) - P(j|Ξ·_r)] Γ— Ξ·_r[LV] Γ— x_attr
```

---

## 3. GPU λ°°μΉ μ²λ¦¬

### 3.1 μ™„μ „ λ³‘λ ¬ν™”
```python
# λ¨λ“  κ°μΈ Γ— λ¨λ“  drawsλ¥Ό ν• λ²μ— GPUλ΅ κ³„μ‚°
total_ll = compute_all_individuals_likelihood_full_batch_gpu(
    gpu_measurement_model,
    all_ind_data,      # λ¨λ“  κ°μΈ λ°μ΄ν„°
    draws,             # λ¨λ“  draws
    param_dict,
    structural_model,
    choice_model
)
```

### 3.2 μ„±λ¥ ν–¥μƒ
- β… **CPU μμ°¨ μ²λ¦¬**: κ°μΈλ³„ β†’ Drawλ³„ β†’ μ„ νƒμƒν™©λ³„ (3μ¤‘ λ£¨ν”„)
- β… **GPU λ°°μΉ μ²λ¦¬**: λ¨λ“  κ²ƒμ„ ν• λ²μ— κ³„μ‚° (λ£¨ν”„ μ κ±°)
- β… **μ†λ„ ν–¥μƒ**: μ•½ 10-100λ°° λΉ λ¦„

---

## 4. μµμ ν™” κ³Όμ •

### 4.1 L-BFGS-B μ•κ³ λ¦¬μ¦
```python
scipy.optimize.minimize(
    fun=objective_function,      # -LL (μµμ†ν™”)
    x0=initial_params,           # μ΄κΈ°κ°’ (0.1)
    method='L-BFGS-B',           # μ¤€λ‰΄ν„΄λ²•
    jac=gradient_function,       # ν•΄μ„μ  κ·Έλλ””μ–ΈνΈ
    bounds=bounds,               # νλΌλ―Έν„° λ²”μ„
    options={'maxiter': 1000}
)
```

### 4.2 νλΌλ―Έν„° μ¤μΌ€μΌλ§
```
λ¬Έμ : νλΌλ―Έν„° ν¬κΈ° λ¶κ· ν•
- μΈ΅μ •λ¨λΈ: 0.1 ~ 10
- κµ¬μ΅°λ¨λΈ: -5 ~ 5
- μ„ νƒλ¨λΈ: -10 ~ 10

ν•΄κ²°: νλΌλ―Έν„° μ¤μΌ€μΌλ§
- λ‚΄λ¶€μ μΌλ΅ [-1, 1] λ²”μ„λ΅ μ •κ·ν™”
- μµμ ν™” ν›„ μ›λ μ¤μΌ€μΌλ΅ λ³µμ›
```

---

## 5. μ£Όμ” ν΄λμ¤ λ° νμΌ

### 5.1 μ‹¤ν–‰ μ¤ν¬λ¦½νΈ
- **test_gpu_batch_iclv.py**: λ™μ‹μ¶”μ • μ‹¤ν–‰ μ¤ν¬λ¦½νΈ

### 5.2 ν•µμ‹¬ ν΄λμ¤
- **SimultaneousGPUBatchEstimator**: GPU λ°°μΉ μ²λ¦¬ μ¶”μ •κΈ°
- **ParameterManager**: νλΌλ―Έν„° κ΄€λ¦¬ (λ°°μ—΄ β†” λ”•μ…”λ„λ¦¬ λ³€ν™)
- **MultiLatentJointGradient**: κ·Έλλ””μ–ΈνΈ κ³„μ‚°

### 5.3 GPU λ¨λ“
- **gpu_gradient_batch.py**: GPU λ°°μΉ κ·Έλλ””μ–ΈνΈ κ³„μ‚°
- **gpu_batch_utils.py**: GPU μ ν‹Έλ¦¬ν‹° ν•¨μ

---

## 6. κ²°κ³Ό ν•΄μ„

### 6.1 μ¶λ ¥ νμΌ
```
simultaneous_{κ²½λ΅λ…}_{μ„ νƒλ¨λΈLV}_results_{timestamp}.csv
- λ¨λ“  νλΌλ―Έν„° μ¶”μ •κ°’, ν‘μ¤€μ¤μ°¨, p-value
- AIC, BIC, μµμΆ… λ΅κ·Έμ°λ„

simultaneous_{κ²½λ΅λ…}_{μ„ νƒλ¨λΈLV}_results_{timestamp}.npy
- μ›μ‹ νλΌλ―Έν„° λ°°μ—΄ (NumPy ν•μ‹)
```

### 6.2 νλΌλ―Έν„° ν•΄μ„

#### κµ¬μ΅°λ¨λΈ
```
gamma_HC_to_PB = 0.45 (p < 0.001)
β†’ κ±΄κ°•κ΄€μ‹¬μ΄ 1 μ¦κ°€ν•λ©΄ μΈμ§€λ ννƒμ΄ 0.45 μ¦κ°€
```

#### μ„ νƒλ¨λΈ
```
theta_sugar_free_PI = 0.82 (p < 0.001)
β†’ κµ¬λ§¤μλ„κ°€ 1 μ¦κ°€ν•λ©΄ λ¬΄μ„¤νƒ• μ„ νƒ ν™•λ¥ μ΄ exp(0.82) = 2.27λ°° μ¦κ°€

beta_price = -0.15 (p < 0.001)
β†’ κ°€κ²©μ΄ 1μ› μ¦κ°€ν•λ©΄ μ„ νƒ ν™•λ¥ μ΄ exp(-0.15) = 0.86λ°° κ°μ†
```

---

## 7. ν•µμ‹¬ μμ‹ μ •λ¦¬

### 7.1 μ „μ²΄ λ΅κ·Έμ°λ„
```
LL = Ξ£_i log[ (1/R) Ξ£_r P(Y_i, I_i | Ξ·_ir, ΞΈ) ]

P(Y_i, I_i | Ξ·_ir, ΞΈ) = P(I_i | Ξ·_ir) Γ— P(Y_i | Ξ·_ir, ΞΈ) Γ— P(Ξ·_ir | ΞΈ)
```

### 7.2 Importance Weighting
```
w_r = exp(LL_r) / Ξ£_r' exp(LL_r')
```

### 7.3 κ°€μ¤‘ν‰κ·  κ·Έλλ””μ–ΈνΈ
```
β‚LL/β‚ΞΈ = Ξ£_r w_r Γ— β‚LL_r/β‚ΞΈ
```

---

## 8. μμ£Ό λ¬»λ” μ§λ¬Έ

**Q1: μ™ μΈ΅μ •λ¨λΈ νλΌλ―Έν„°λ¥Ό κ³ μ •ν•λ‚μ”?**
- A: CFAμ—μ„ μ΄λ―Έ μ •ν™•ν•κ² μ¶”μ •ν–κΈ° λ•λ¬Έμ…λ‹λ‹¤. λ™μ‹μ¶”μ •μ—μ„λ” κµ¬μ΅°λ¨λΈκ³Ό μ„ νƒλ¨λΈμ— μ§‘μ¤‘ν•©λ‹λ‹¤.

**Q2: Importance Weightingμ΄ μ™ ν•„μ”ν•κ°€μ”?**
- A: λ¨λ“  drawsκ°€ λ™λ“±ν•κ² μ¤‘μ”ν• κ²ƒμ΄ μ•„λ‹™λ‹λ‹¤. μ°λ„κ°€ λ†’μ€ drawsμ— λ” ν° κ°€μ¤‘μΉλ¥Ό λ¶€μ—¬ν•μ—¬ μ¶”μ • ν¨μ¨μ„ λ†’μ…λ‹λ‹¤.

**Q3: GPU λ°°μΉ μ²λ¦¬μ μ¥μ μ€?**
- A: CPUμ—μ„λ” 3μ¤‘ λ£¨ν”„(κ°μΈ-draw-μ„ νƒμƒν™©)κ°€ ν•„μ”ν•μ§€λ§, GPUλ” λ¨λ“  κ³„μ‚°μ„ λ³‘λ ¬λ΅ ν• λ²μ— μ²λ¦¬ν•μ—¬ 10-100λ°° λΉ λ¦…λ‹λ‹¤.

**Q4: νλΌλ―Έν„° μ¤μΌ€μΌλ§μ΄ μ™ ν•„μ”ν•κ°€μ”?**
- A: νλΌλ―Έν„° ν¬κΈ°κ°€ λ‹¤λ¥΄λ©΄ μµμ ν™”κ°€ λ¶μ•μ •ν•΄μ§‘λ‹λ‹¤. μ¤μΌ€μΌλ§μΌλ΅ λ¨λ“  νλΌλ―Έν„°λ¥Ό λΉ„μ·ν• λ²”μ„λ΅ λ§λ“¤μ–΄ μ•μ •μ μΈ μµμ ν™”λ¥Ό λ³΄μ¥ν•©λ‹λ‹¤.

