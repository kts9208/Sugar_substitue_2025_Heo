# ìˆœì°¨ì¶”ì • ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ìˆœì°¨ì¶”ì •ì„ 1ë‹¨ê³„ì™€ 2ë‹¨ê³„ë¡œ ë¶„ë¦¬í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
1ë‹¨ê³„ì—ì„œ ì ì¬ë³€ìˆ˜ ê°„ ê´€ê³„ë¥¼ í™•ì¸í•œ í›„, 2ë‹¨ê³„ì—ì„œ ì„ íƒëª¨ë¸ì„ ì¶”ì •í•©ë‹ˆë‹¤.

### ì¥ì 
- âœ… **1ë‹¨ê³„ ê²°ê³¼ ê²€í†  ê°€ëŠ¥**: ì ì¬ë³€ìˆ˜ ê°„ ê²½ë¡œê³„ìˆ˜ í™•ì¸ í›„ ì§„í–‰
- âœ… **ì„¸ì…˜ ë¶„ë¦¬ ê°€ëŠ¥**: 1ë‹¨ê³„ ì‹¤í–‰ â†’ ê²°ê³¼ ê²€í†  â†’ 2ë‹¨ê³„ ì‹¤í–‰
- âœ… **ì‹¤í—˜ íš¨ìœ¨ì„±**: 1ë‹¨ê³„ ê³ ì • â†’ ì—¬ëŸ¬ ì„ íƒëª¨ë¸ í…ŒìŠ¤íŠ¸
- âœ… **ì¬í˜„ì„± ë³´ì¥**: ìš”ì¸ì ìˆ˜ íŒŒì¼ ì €ì¥ â†’ ë™ì¼í•œ ê°’ìœ¼ë¡œ ì¬ì‹¤í–‰

---

## ğŸ”„ ì›Œí¬í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì¸¡ì •ëª¨ë¸ + êµ¬ì¡°ëª¨ë¸ (SEM)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ì¸¡ì •ëª¨ë¸ ì¶”ì • (CFA)                                         â”‚
â”‚ - êµ¬ì¡°ëª¨ë¸ ì¶”ì • (ê²½ë¡œë¶„ì„)                                     â”‚
â”‚ - ìš”ì¸ì ìˆ˜ ì¶”ì¶œ ë° í‘œì¤€í™”                                      â”‚
â”‚ - ê²°ê³¼ ì €ì¥: stage1_results.pkl                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    ê²°ê³¼ íŒŒì¼ ê²€í† 
                    - ê²½ë¡œê³„ìˆ˜ í™•ì¸
                    - ì í•©ë„ ì§€ìˆ˜ í™•ì¸
                    - ìš”ì¸ì ìˆ˜ ë¶„í¬ í™•ì¸
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì„ íƒëª¨ë¸                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ìš”ì¸ì ìˆ˜ ë¡œë“œ (stage1_results.pkl)                         â”‚
â”‚ - ì„ íƒëª¨ë¸ ì¶”ì • (Multinomial Logit)                          â”‚
â”‚ - ìµœì¢… ê²°ê³¼ ì¶œë ¥                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ì‚¬ìš© ë°©ë²•

### ë°©ë²• 1: ì˜ˆì œ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê¶Œì¥)

#### 1ë‹¨ê³„ ì‹¤í–‰
```bash
python examples/sequential_stage1_example.py
```

**ì¶œë ¥:**
- `results/stage1_results.pkl`: 1ë‹¨ê³„ ì „ì²´ ê²°ê³¼
- `logs/stage1_estimation.log`: ì¶”ì • ë¡œê·¸
- ì½˜ì†”: ê²½ë¡œê³„ìˆ˜, ì í•©ë„ ì§€ìˆ˜, ìš”ì¸ì ìˆ˜ í†µê³„

#### 2ë‹¨ê³„ ì‹¤í–‰
```bash
python examples/sequential_stage2_with_extended_model.py
```

**ì¶œë ¥:**
- `results/sequential_stage_wise/{ëª¨ë¸ëª…}_parameters.csv`: íŒŒë¼ë¯¸í„° ì¶”ì •ì¹˜ (ê³„ìˆ˜, í‘œì¤€ì˜¤ì°¨, tê°’, pê°’)
- `results/sequential_stage_wise/{ëª¨ë¸ëª…}_fit.csv`: ì í•©ë„ (ë¡œê·¸ìš°ë„, AIC, BIC)
- `logs/stage2_estimation.log`: ì¶”ì • ë¡œê·¸
- ì½˜ì†”: ì„ íƒëª¨ë¸ íŒŒë¼ë¯¸í„°, AIC, BIC

---

### ë°©ë²• 2: Python ì½”ë“œì—ì„œ ì§ì ‘ ì‚¬ìš©

#### 1ë‹¨ê³„: ì¸¡ì •ëª¨ë¸ + êµ¬ì¡°ëª¨ë¸

```python
from src.analysis.hybrid_choice_model.iclv_models.sequential_estimator import SequentialEstimator
from src.analysis.hybrid_choice_model.iclv_models.measurement_equations import MultiLatentMeasurement
from src.analysis.hybrid_choice_model.iclv_models.structural_equations import MultiLatentStructural
from src.analysis.hybrid_choice_model.config import MultiLatentConfig

# ì„¤ì • ë° ëª¨ë¸ ìƒì„±
config = MultiLatentConfig(...)
measurement_model = MultiLatentMeasurement(config)
structural_model = MultiLatentStructural(config)
estimator = SequentialEstimator(config)

# 1ë‹¨ê³„ ì‹¤í–‰
stage1_results = estimator.estimate_stage1_only(
    data=data,
    measurement_model=measurement_model,
    structural_model=structural_model,
    save_path='results/stage1_results.pkl',  # ê²°ê³¼ ì €ì¥
    log_file='logs/stage1.log'
)

# ê²°ê³¼ í™•ì¸
print(stage1_results['paths'])  # ì ì¬ë³€ìˆ˜ ê°„ ê²½ë¡œê³„ìˆ˜
print(stage1_results['fit_indices'])  # ì í•©ë„ ì§€ìˆ˜
```

#### 2ë‹¨ê³„: ì„ íƒëª¨ë¸

```python
from src.analysis.hybrid_choice_model.iclv_models.choice_model import MultinomialLogitChoice

# ì„ íƒëª¨ë¸ ìƒì„±
choice_model = MultinomialLogitChoice(...)

# 2ë‹¨ê³„ ì‹¤í–‰ (íŒŒì¼ì—ì„œ ìš”ì¸ì ìˆ˜ ë¡œë“œ)
stage2_results = estimator.estimate_stage2_only(
    data=data,
    choice_model=choice_model,
    factor_scores='results/stage1_results.pkl',  # íŒŒì¼ ê²½ë¡œ
    log_file='logs/stage2.log'
)

# ë˜ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ì§ì ‘ ì „ë‹¬
stage2_results = estimator.estimate_stage2_only(
    data=data,
    choice_model=choice_model,
    factor_scores=stage1_results['factor_scores'],  # ë”•ì…”ë„ˆë¦¬
    log_file='logs/stage2.log'
)
```

---

## ğŸ“Š 1ë‹¨ê³„ ê²°ê³¼ êµ¬ì¡°

`estimate_stage1_only()` ë°˜í™˜ê°’:

```python
{
    'sem_results': Dict,  # SEM ì „ì²´ ê²°ê³¼
    'factor_scores': {  # ìš”ì¸ì ìˆ˜ (í‘œì¤€í™”ë¨)
        'purchase_intention': np.ndarray,
        'perceived_price': np.ndarray,
        ...
    },
    'paths': pd.DataFrame,  # ì ì¬ë³€ìˆ˜ ê°„ ê²½ë¡œê³„ìˆ˜
    'loadings': pd.DataFrame,  # ìš”ì¸ì ì¬ëŸ‰
    'fit_indices': {  # ì í•©ë„ ì§€ìˆ˜
        'CFI': float,
        'TLI': float,
        'RMSEA': float,
        'SRMR': float
    },
    'log_likelihood': float,
    'save_path': str  # ì €ì¥ ê²½ë¡œ (ì €ì¥í•œ ê²½ìš°)
}
```

---

## ğŸ’¾ ì €ì¥/ë¡œë“œ ë©”ì„œë“œ

### ì „ì²´ ê²°ê³¼ ì €ì¥/ë¡œë“œ

```python
# ì €ì¥
SequentialEstimator.save_stage1_results(
    results=stage1_results,
    path='results/stage1_results.pkl'
)

# ë¡œë“œ
loaded_results = SequentialEstimator.load_stage1_results(
    path='results/stage1_results.pkl'
)
```

### ìš”ì¸ì ìˆ˜ë§Œ ì €ì¥/ë¡œë“œ (ê²½ëŸ‰)

```python
# ì €ì¥
SequentialEstimator.save_factor_scores(
    factor_scores=stage1_results['factor_scores'],
    path='results/factor_scores.pkl'
)

# ë¡œë“œ
factor_scores = SequentialEstimator.load_factor_scores(
    path='results/factor_scores.pkl'
)
```

---

## ğŸ” 1ë‹¨ê³„ ê²°ê³¼ ê²€í†  ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1. ê²½ë¡œê³„ìˆ˜ (Paths)
- [ ] ëª¨ë“  ê²½ë¡œê°€ ìœ ì˜í•œê°€?
- [ ] ê²½ë¡œ ë°©í–¥ì´ ì´ë¡ ê³¼ ì¼ì¹˜í•˜ëŠ”ê°€?
- [ ] ê²½ë¡œ í¬ê¸°ê°€ í•©ë¦¬ì ì¸ê°€?

### 2. ì í•©ë„ ì§€ìˆ˜
- [ ] CFI â‰¥ 0.90
- [ ] TLI â‰¥ 0.90
- [ ] RMSEA â‰¤ 0.08
- [ ] SRMR â‰¤ 0.08

### 3. ìš”ì¸ì ìˆ˜
- [ ] í‰ê·  â‰ˆ 0, í‘œì¤€í¸ì°¨ â‰ˆ 1 (í‘œì¤€í™” í™•ì¸)
- [ ] NaN/Inf ì—†ìŒ
- [ ] ë¶„í¬ê°€ í•©ë¦¬ì ì¸ê°€?

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ìš”ì¸ì ìˆ˜ í‘œì¤€í™”**: 1ë‹¨ê³„ì—ì„œ ìë™ìœ¼ë¡œ Z-score í‘œì¤€í™”ë¨
2. **íŒŒì¼ í˜•ì‹**: `.pkl` (pickle) í˜•ì‹ ì‚¬ìš© ê¶Œì¥
3. **ë°ì´í„° ì¼ê´€ì„±**: 1ë‹¨ê³„ì™€ 2ë‹¨ê³„ì—ì„œ ë™ì¼í•œ ë°ì´í„° ì‚¬ìš©
4. **ì„¤ì • ì¼ê´€ì„±**: 1ë‹¨ê³„ì™€ 2ë‹¨ê³„ì—ì„œ ë™ì¼í•œ `config` ì‚¬ìš©

---

## ğŸ¯ í™œìš© ì‚¬ë¡€

### ì‚¬ë¡€ 1: ì—¬ëŸ¬ ì„ íƒëª¨ë¸ ë¹„êµ
```python
# 1ë‹¨ê³„ 1íšŒ ì‹¤í–‰
stage1_results = estimator.estimate_stage1_only(...)

# 2ë‹¨ê³„ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ (ë‹¤ë¥¸ ì„ íƒëª¨ë¸)
for choice_model in [model1, model2, model3]:
    results = estimator.estimate_stage2_only(
        data, choice_model, stage1_results['factor_scores']
    )
```

### ì‚¬ë¡€ 2: ì„¸ì…˜ ë¶„ë¦¬
```bash
# Day 1: 1ë‹¨ê³„ ì‹¤í–‰
python run_stage1.py
# â†’ results/stage1_results.pkl ìƒì„±

# Day 2: ê²°ê³¼ ê²€í†  í›„ 2ë‹¨ê³„ ì‹¤í–‰
python run_stage2.py
```

---

## ğŸ“š ì°¸ê³ 

- ì „ì²´ ì¶”ì • (1ë‹¨ê³„ + 2ë‹¨ê³„ í†µí•©): `estimator.estimate()`
- API ë¬¸ì„œ: `docs/API_REFERENCE.md`
- ICLV ê°€ì´ë“œ: `docs/ICLV_COMPLETE_SYSTEM_GUIDE.md`

