# BHHH ë°©ë²• ë°˜ë³µ ìˆ˜ ë¶„ì„

## ðŸŽ¯ ì§ˆë¬¸

BHHH ê¸°ë²•ì„ ì‚¬ìš©í•  ë•Œ **ìš°ë„ ê³„ì‚° ë° ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚° ë°˜ë³µ ìˆ˜**ê°€ ì–¼ë§ˆë‚˜ ë˜ëŠ”ê°€?

---

## ðŸ“Š BHHH ë°©ë²• êµ¬ì¡° ë¶„ì„

### **í˜„ìž¬ êµ¬í˜„ ì½”ë“œ**

```python
# ì¡°ê¸° ì¢…ë£Œ í›„ Hessian ì—­í–‰ë ¬ ê³„ì‚° (BHHH ë°©ë²•)
if self.config.estimation.calculate_se:
    self.logger.info("ì¡°ê¸° ì¢…ë£Œ í›„ Hessian ì—­í–‰ë ¬ ê³„ì‚° ì¤‘ (BHHH ë°©ë²•)...")
    
    n_params = len(early_stopping_wrapper.best_x)  # 202ê°œ
    
    # ê°œì¸ë³„ gradient ê³„ì‚°
    individual_gradients = []
    param_dict = self._unpack_parameters(
        early_stopping_wrapper.best_x,
        measurement_model,
        structural_model,
        choice_model
    )
    
    # ê° ê°œì¸ì— ëŒ€í•´ gradient ê³„ì‚°
    for i, (person_id, ind_data) in enumerate(data.groupby('person_id')):
        if i >= 50:  # ìµœëŒ€ 50ëª…ë§Œ ì‚¬ìš©
            break
        
        ind_draws = halton_draws[i] if i < len(halton_draws) else halton_draws[0]
        
        # ê°œì¸ë³„ gradient ê³„ì‚°
        grad_dict = self.joint_grad.compute_individual_gradient(
            ind_data=ind_data,
            ind_draws=ind_draws,
            params_dict=param_dict,
            measurement_model=measurement_model,
            structural_model=structural_model,
            choice_model=choice_model
        )
        
        # Gradientë¥¼ ë²¡í„°ë¡œ ë³€í™˜
        grad_vector = self._pack_gradient(
            grad_dict,
            measurement_model,
            structural_model,
            choice_model
        )
        
        individual_gradients.append(grad_vector)
    
    # BHHH Hessian ê³„ì‚°: H = Î£ (g_i Ã— g_i^T)
    hessian_bhhh = np.zeros((n_params, n_params))
    for grad in individual_gradients:
        hessian_bhhh += np.outer(grad, grad)  # O(n_params^2)
    
    # Hessian ì—­í–‰ë ¬ ê³„ì‚°
    hess_inv = np.linalg.inv(hessian_bhhh)  # O(n_params^3)
```

---

## ðŸ”¢ ë°˜ë³µ ìˆ˜ ê³„ì‚°

### **1. ìš°ë„ ê³„ì‚° íšŸìˆ˜**

#### BHHH ë°©ë²•
```
ìš°ë„ ê³„ì‚° = 0íšŒ
```

**ì´ìœ **: 
- BHHHëŠ” **gradientë§Œ ê³„ì‚°**
- `compute_individual_gradient()` í•¨ìˆ˜ëŠ” ìš°ë„ë¥¼ ê³„ì‚°í•˜ì§€ ì•ŠìŒ
- Gradientë§Œ ê³„ì‚°í•˜ì—¬ outer product ìˆ˜í–‰

---

### **2. ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚° íšŸìˆ˜**

#### BHHH ë°©ë²•
```
ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚° = 50íšŒ (ê°œì¸ë³„)
```

**ìƒì„¸**:
- ê°œì¸ ìˆ˜: 50ëª… (ìµœëŒ€ê°’ ì„¤ì •)
- ê° ê°œì¸ë‹¹ 1íšŒ gradient ê³„ì‚°
- **ì´ 50íšŒ**

---

### **3. `compute_individual_gradient()` ë‚´ë¶€ ê³„ì‚°**

ê° ê°œì¸ë³„ gradient ê³„ì‚° ì‹œ:

```python
def compute_individual_gradient(self, ind_data, ind_draws, params_dict, ...):
    # 1. LV ê°’ ê³„ì‚° (100 draws)
    lvs_list = []
    for draw_idx in range(n_draws):  # 100íšŒ
        latent_vars = structural_model.predict(...)
        lvs_list.append(latent_vars)
    
    # 2. ê° drawì˜ ê²°í•© likelihood ê³„ì‚°
    ll_batch = self.gpu_grad.compute_joint_likelihood_batch_gpu(...)  # GPU ë°°ì¹˜ ì²˜ë¦¬
    
    # 3. Importance weights ê³„ì‚°
    weights = self.gpu_grad.compute_importance_weights_gpu(ll_batch)
    
    # 4. ê°€ì¤‘í‰ê·  ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚°
    grad_meas = self.gpu_grad.compute_measurement_gradient_batch_gpu(..., weights)
    grad_struct = self.gpu_grad.compute_structural_gradient_batch_gpu(..., weights)
    grad_choice = self.gpu_grad.compute_choice_gradient_batch_gpu(..., weights)
    
    return {'measurement': grad_meas, 'structural': grad_struct, 'choice': grad_choice}
```

**ê° ê°œì¸ë‹¹**:
- LV ì˜ˆì¸¡: 100íšŒ (CPU, ë¹ ë¦„)
- ìš°ë„ ê³„ì‚°: 1íšŒ (GPU ë°°ì¹˜, 100 draws ë™ì‹œ ì²˜ë¦¬)
- Gradient ê³„ì‚°: 3íšŒ (ì¸¡ì •/êµ¬ì¡°/ì„ íƒ ëª¨ë¸, GPU ë°°ì¹˜)

**50ëª… ì „ì²´**:
- LV ì˜ˆì¸¡: 50 Ã— 100 = 5,000íšŒ (CPU)
- ìš°ë„ ê³„ì‚°: 50 Ã— 1 = **50íšŒ** (GPU)
- Gradient ê³„ì‚°: 50 Ã— 3 = 150íšŒ (GPU)

---

## â±ï¸ ì†Œìš” ì‹œê°„ ì¶”ì •

### **BHHH ë°©ë²•**

| ìž‘ì—… | íšŸìˆ˜ | ë‹¨ìœ„ ì‹œê°„ | ì´ ì‹œê°„ |
|------|------|-----------|---------|
| LV ì˜ˆì¸¡ (CPU) | 5,000íšŒ | 0.001ì´ˆ | 5ì´ˆ |
| ìš°ë„ ê³„ì‚° (GPU) | 50íšŒ | 0.2ì´ˆ | 10ì´ˆ |
| Gradient ê³„ì‚° (GPU) | 150íšŒ | 0.5ì´ˆ | 75ì´ˆ |
| Outer product | 50íšŒ | 0.01ì´ˆ | 0.5ì´ˆ |
| ì—­í–‰ë ¬ ê³„ì‚° | 1íšŒ | 0.1ì´ˆ | 0.1ì´ˆ |
| **ì´ ì†Œìš” ì‹œê°„** | - | - | **~90ì´ˆ (1.5ë¶„)** |

---

## ðŸ“ˆ ë¹„êµ: ìˆ˜ì¹˜ì  ë°©ë²• vs BHHH

### **ìˆ˜ì¹˜ì  ë°©ë²• (ëŒ€ê° ì›ì†Œë§Œ)**

ë¡œê·¸ì—ì„œ í™•ì¸:
```
2025-11-09 23:09:45 - ì¡°ê¸° ì¢…ë£Œ: 20íšŒ ì—°ì† í•¨ìˆ˜ í˜¸ì¶œì—ì„œ LL ê°œì„  ì—†ìŒ
2025-11-09 23:09:45 - ì¡°ê¸° ì¢…ë£Œ í›„ Hessian ì—­í–‰ë ¬ ê³„ì‚° ì¤‘ (ìˆ˜ì¹˜ì  ë°©ë²•)...
2025-11-09 23:09:45 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #46
2025-11-09 23:10:06 - Iter   46: LL =  -40903.4451
2025-11-09 23:10:06 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #47
...
2025-11-09 23:28:07 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #96
```

**ê³„ì‚°**:
- ì‹œìž‘: #46 (23:09:45)
- í˜„ìž¬: #96 (23:28:07)
- ê²½ê³¼ ì‹œê°„: 18ë¶„ 22ì´ˆ
- ìš°ë„ ê³„ì‚°: 50íšŒ (46~96)
- **ì•„ì§ ì§„í–‰ ì¤‘!**

**ì˜ˆìƒ ì´ ê³„ì‚°**:
```python
# ìˆ˜ì¹˜ì  ë°©ë²• (ëŒ€ê° ì›ì†Œë§Œ)
# grad_0 = approx_fprime(best_x, negative_log_likelihood, eps)
# ì´ í•¨ìˆ˜ëŠ” ê° íŒŒë¼ë¯¸í„°ë¥¼ epsë§Œí¼ ë³€í™”ì‹œì¼œ ìš°ë„ ê³„ì‚°

# approx_fprime ë‚´ë¶€:
for i in range(n_params):  # 202ë²ˆ
    x_plus = x.copy()
    x_plus[i] += eps
    f_plus = func(x_plus)  # ìš°ë„ ê³„ì‚° 1íšŒ
    grad[i] = (f_plus - f_0) / eps

# ì´ ìš°ë„ ê³„ì‚°: 1 + 202 = 203íšŒ (grad_0 ê³„ì‚°ìš©)

# Hessian ëŒ€ê° ì›ì†Œ ê³„ì‚°:
for i in range(n_params):  # 202ë²ˆ
    x_plus = best_x.copy()
    x_plus[i] += eps
    grad_i_plus = approx_fprime(x_plus, negative_log_likelihood, eps)  # 203íšŒ
    hessian_diag[i] = (grad_i_plus[i] - grad_0[i]) / eps

# ì´ ìš°ë„ ê³„ì‚°: 203 + (202 Ã— 203) = 203 + 41,006 = 41,209íšŒ
```

**ì†Œìš” ì‹œê°„**:
- ìš°ë„ ê³„ì‚° 1íšŒ: ~22ì´ˆ (GPU)
- ì´ ì‹œê°„: 41,209 Ã— 22ì´ˆ = 906,598ì´ˆ â‰ˆ **252ì‹œê°„ â‰ˆ 10.5ì¼**

---

### **ë¹„êµ í‘œ**

| ë°©ë²• | ìš°ë„ ê³„ì‚° | ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚° | ì†Œìš” ì‹œê°„ | Hessian í¬ê¸° |
|------|-----------|----------------|-----------|--------------|
| **ìˆ˜ì¹˜ì  (ëŒ€ê°)** | 41,209íšŒ | 0íšŒ | 10.5ì¼ | ëŒ€ê°ë§Œ (202ê°œ) |
| **BHHH** | 50íšŒ | 150íšŒ | 1.5ë¶„ | ì „ì²´ (40,804ê°œ) |
| **ì†ë„ í–¥ìƒ** | - | - | **10,080ë°°** | - |

---

## ðŸ” ë¡œê·¸ ë¶„ì„: ì™œ ì´ë ‡ê²Œ ë§Žì€ ë°˜ë³µì´?

### **ë¡œê·¸ì—ì„œ ë³¸ íŒ¨í„´**

```
23:09:45 - ì¡°ê¸° ì¢…ë£Œ í›„ Hessian ì—­í–‰ë ¬ ê³„ì‚° ì¤‘ (ìˆ˜ì¹˜ì  ë°©ë²•)...
23:09:45 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #46
23:10:06 - Iter   46: LL =  -40903.4451
23:10:06 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #47
23:10:29 - Iter   47: LL =  -40903.4447 [NEW BEST]
...
23:28:07 - [ë‹¨ê³„ 1/2] ìš°ë„ ê³„ì‚° #96
```

**ë¶„ì„**:
1. #45ì—ì„œ ì¡°ê¸° ì¢…ë£Œ ë°œìƒ
2. "ìˆ˜ì¹˜ì  ë°©ë²•" ë©”ì‹œì§€ ì¶œë ¥ â†’ **ì´ì „ ì½”ë“œ ì‹¤í–‰ ì¤‘**
3. #46ë¶€í„° ìš°ë„ ê³„ì‚° ì‹œìž‘
4. #96ê¹Œì§€ ì§„í–‰ (50íšŒ ê³„ì‚°)
5. **ì•„ì§ ì§„í–‰ ì¤‘** (202ê°œ íŒŒë¼ë¯¸í„° ì¤‘ 50ê°œë§Œ ì™„ë£Œ)

**ì˜ˆìƒ ë‚¨ì€ ì‹œê°„**:
- ì™„ë£Œ: 50/202 = 24.8%
- ë‚¨ì€ ê³„ì‚°: 152ê°œ íŒŒë¼ë¯¸í„°
- ë‚¨ì€ ìš°ë„ ê³„ì‚°: 152 Ã— 203 = 30,856íšŒ
- ë‚¨ì€ ì‹œê°„: 30,856 Ã— 22ì´ˆ = 678,832ì´ˆ â‰ˆ **188ì‹œê°„ â‰ˆ 7.8ì¼**

---

## ðŸ’¡ BHHH ë°©ë²•ì˜ ìž¥ì  ìž¬í™•ì¸

### **1. ê³„ì‚° íš¨ìœ¨ì„±**

| ë‹¨ê³„ | ìˆ˜ì¹˜ì  ë°©ë²• | BHHH ë°©ë²• |
|------|------------|-----------|
| Gradient ê³„ì‚° | approx_fprime Ã— 203íšŒ | compute_individual_gradient Ã— 50íšŒ |
| ìš°ë„ ê³„ì‚° | 41,209íšŒ | 50íšŒ |
| ì†Œìš” ì‹œê°„ | 10.5ì¼ | 1.5ë¶„ |

**BHHHê°€ 10,080ë°° ë¹ ë¥¸ ì´ìœ **:
1. âœ… ìš°ë„ ê³„ì‚° ëŒ€ì‹  gradient ì§ì ‘ ê³„ì‚°
2. âœ… GPU ë°°ì¹˜ ì²˜ë¦¬ í™œìš©
3. âœ… 50ëª…ë§Œ ìƒ˜í”Œë§ (ì „ì²´ 326ëª… ì¤‘)
4. âœ… Analytic gradient ì‚¬ìš© (ìˆ˜ì¹˜ì  ë¯¸ë¶„ ë¶ˆí•„ìš”)

---

### **2. ì •í™•ì„±**

| ë°©ë²• | Hessian í¬ê¸° | ìƒê´€ê´€ê³„ | í‘œì¤€ì˜¤ì°¨ ì •í™•ë„ |
|------|--------------|----------|----------------|
| ìˆ˜ì¹˜ì  (ëŒ€ê°) | 202ê°œ | âŒ ë¬´ì‹œ | ë‚®ìŒ |
| BHHH | 40,804ê°œ | âœ… í¬í•¨ | ë†’ìŒ |

---

### **3. ì‹¤ìš©ì„±**

**ìˆ˜ì¹˜ì  ë°©ë²•**:
- âŒ 10.5ì¼ ì†Œìš” â†’ ì‹¤ìš©ì ì´ì§€ ì•ŠìŒ
- âŒ ëŒ€ê° ì›ì†Œë§Œ â†’ ì •í™•ë„ ë‚®ìŒ
- âŒ GPU ë¦¬ì†ŒìŠ¤ ìž¥ì‹œê°„ ì ìœ 

**BHHH ë°©ë²•**:
- âœ… 1.5ë¶„ ì†Œìš” â†’ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥
- âœ… ì „ì²´ Hessian â†’ ì •í™•ë„ ë†’ìŒ
- âœ… GPU íš¨ìœ¨ì  ì‚¬ìš©

---

## ðŸŽ¯ ê²°ë¡ 

### **BHHH ë°©ë²• ë°˜ë³µ ìˆ˜**

1. **ìš°ë„ ê³„ì‚°**: 50íšŒ (ê°œì¸ë³„ 1íšŒ Ã— 50ëª…)
2. **ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚°**: 150íšŒ (ê°œì¸ë³„ 3íšŒ Ã— 50ëª…)
3. **ì´ ì†Œìš” ì‹œê°„**: ~1.5ë¶„

### **ìˆ˜ì¹˜ì  ë°©ë²• ë°˜ë³µ ìˆ˜ (ë¡œê·¸ ê¸°ì¤€)**

1. **ìš°ë„ ê³„ì‚°**: 41,209íšŒ (ì˜ˆìƒ)
2. **ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚°**: 0íšŒ
3. **ì´ ì†Œìš” ì‹œê°„**: ~10.5ì¼ (ì˜ˆìƒ)
4. **í˜„ìž¬ ì§„í–‰**: 50/41,209 = 0.12% (ê±°ì˜ ì‹œìž‘ ë‹¨ê³„)

### **ìµœì¢… ê¶Œìž¥**

**BHHH ë°©ë²• ì‚¬ìš© ê°•ë ¥ ê¶Œìž¥**:
- âœ… 10,080ë°° ë¹ ë¦„ (10.5ì¼ â†’ 1.5ë¶„)
- âœ… ë” ì •í™•í•¨ (ì „ì²´ Hessian vs ëŒ€ê°ë§Œ)
- âœ… ì‹¤ìš©ì  (ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥)
- âœ… ì´ë¯¸ êµ¬í˜„ ì™„ë£Œ

**ìˆ˜ì¹˜ì  ë°©ë²•**:
- âŒ ë¹„í˜„ì‹¤ì ìœ¼ë¡œ ëŠë¦¼
- âŒ ì •í™•ë„ ë‚®ìŒ
- âŒ ì‚¬ìš© ë¶ˆê°€ëŠ¥

---

## ðŸ“ ìƒ˜í”Œë§ ê°œìˆ˜ ì¡°ì • ì˜µì…˜

í˜„ìž¬: 50ëª… ì‚¬ìš© (1.5ë¶„)

| ìƒ˜í”Œ í¬ê¸° | ìš°ë„ ê³„ì‚° | ê·¸ëž˜ë””ì–¸íŠ¸ ê³„ì‚° | ì†Œìš” ì‹œê°„ | ì •í™•ë„ |
|-----------|-----------|----------------|-----------|--------|
| 10ëª… | 10íšŒ | 30íšŒ | 18ì´ˆ | ë‚®ìŒ |
| 25ëª… | 25íšŒ | 75íšŒ | 45ì´ˆ | ì¤‘ê°„ |
| **50ëª…** | **50íšŒ** | **150íšŒ** | **1.5ë¶„** | **ë†’ìŒ** |
| 100ëª… | 100íšŒ | 300íšŒ | 3ë¶„ | ë§¤ìš° ë†’ìŒ |
| 326ëª… (ì „ì²´) | 326íšŒ | 978íšŒ | 10ë¶„ | ìµœê³  |

**ê¶Œìž¥**: 50ëª… (ì •í™•ë„ì™€ ì†ë„ì˜ ê· í˜•)

