# 우도 스케일 균형 분석 보고서

**작성일**: 2025-11-26  
**로그 파일**: `simultaneous_estimation_log_20251126_144000.txt`  
**추정 시간**: 14:40:00 ~ 15:31:17 (약 51분)

---

## 📋 요약

### ⚠️ **심각한 스케일 불균형 발견!**

**최종 결과 (언스케일링)**:
- **측정모델**: -14758.4389 (91.7%) ← **압도적으로 큼**
- **선택모델**: -1340.6232 (8.3%) ← 매우 작음
- **비율**: 측정모델이 선택모델의 **11배**

**초기 상태 (스케일링)**:
- **측정모델**: -711.1828 (24.8%)
- **선택모델**: -2148.9535 (74.9%)
- **비율**: 선택모델이 측정모델의 **3배**

---

## 📊 상세 분석

### 1. 초기 우도 (Iteration #1)

**스케일링된 우도** (최적화에 사용):
```
전체 로그우도: -2867.3737

📈 모델별 우도 성분:
  측정모델: -711.1828 (24.8%)
  선택모델: -2148.9535 (74.9%)
```

**분석**:
- 측정모델과 선택모델의 비율: **1 : 3**
- 선택모델이 더 크지만, 비교적 균형적
- 스케일링이 적용되어 있음

---

### 2. 최종 우도 (Iteration #16)

**스케일링된 우도** (최적화에 사용):
```
스케일링된 우도 (최적화용): -2051.4962
```

**언스케일링된 우도** (실제 우도):
```
언스케일링된 우도 (AIC/BIC용): -16095.5154

📈 모델별 우도 성분:
  측정모델: -14758.4389 (91.7%)
  선택모델: -1340.6232 (8.3%)
```

**분석**:
- 측정모델과 선택모델의 비율: **11 : 1** ← **심각한 불균형!**
- 측정모델이 **압도적으로 큼** (91.7%)
- 선택모델은 전체의 **8.3%에 불과**

---

### 3. 스케일링 효과

**스케일링 비율**:
```
언스케일링 / 스케일링 = -16095.5154 / -2051.4962 = 7.85배
```

**모델별 스케일링 효과**:

| 모델 | 스케일링 (초기) | 언스케일링 (최종) | 스케일링 비율 |
|------|----------------|------------------|--------------|
| 측정모델 | -711.1828 | -14758.4389 | **20.75배** |
| 선택모델 | -2148.9535 | -1340.6232 | **0.62배** |

**발견**:
- 측정모델은 **20.75배 스케일링** (축소됨)
- 선택모델은 **0.62배 스케일링** (확대됨)
- 스케일링이 측정모델을 **과도하게 축소**

---

## 🔍 문제점 분석

### 1. 측정모델 우도가 과도하게 큼

**원인**:
1. **관측치 수의 차이**:
   - 측정모델: 328명 × 15개 지표 = **4,920개 관측치**
   - 선택모델: 328명 × 8개 선택 세트 = **2,624개 선택**
   - 측정모델 관측치가 **1.9배 많음**

2. **모델 복잡도**:
   - 측정모델: 5개 잠재변수 × 3개 지표 = 15개 측정방정식
   - 선택모델: 3개 대안 × 1개 선택 = 1개 선택방정식
   - 측정모델이 **15배 복잡**

3. **우도 계산 방식**:
   - 측정모델: 각 지표마다 독립적으로 우도 계산
   - 선택모델: 선택 세트당 1개 우도만 계산
   - 측정모델 우도가 **누적되어 커짐**

---

### 2. 스케일 불균형의 영향

**최적화에 미치는 영향**:

1. **그래디언트 불균형**:
   - 측정모델 파라미터의 그래디언트가 **과도하게 큼**
   - 선택모델 파라미터의 그래디언트가 **상대적으로 작음**
   - 최적화가 **측정모델 위주로 진행**

2. **파라미터 추정 편향**:
   - 측정모델 파라미터는 **과도하게 정밀하게 추정**
   - 선택모델 파라미터는 **상대적으로 덜 정밀하게 추정**
   - **동시추정의 장점 상실**

3. **수렴 속도**:
   - 측정모델 파라미터가 먼저 수렴
   - 선택모델 파라미터는 **느리게 수렴**
   - 전체 수렴 시간 증가

---

## 📈 반복별 우도 변화

| Iteration | 스케일링 우도 | 개선량 | 비고 |
|-----------|-------------|--------|------|
| 1 (초기) | -2867.3737 | - | 초기값 |
| 2 | -2471.1149 | +396.26 | 큰 개선 |
| 3 | -2258.7545 | +212.36 | 큰 개선 |
| 4 | -2191.2917 | +67.46 | 중간 개선 |
| 5 | -2161.2527 | +30.04 | 작은 개선 |
| 6 | -2147.1529 | +14.10 | 작은 개선 |
| 7 | -2121.4930 | +25.66 | 작은 개선 |
| 8 | -2081.2496 | +40.24 | 중간 개선 |
| 9 | -2054.6864 | +26.56 | 작은 개선 |
| 10 | -2052.2719 | +2.41 | 매우 작은 개선 |
| 11 | -2052.0068 | +0.27 | 매우 작은 개선 |
| 12 | -2051.7588 | +0.25 | 매우 작은 개선 |
| 13 | -2051.6223 | +0.14 | 매우 작은 개선 |
| 14 | -2051.5080 | +0.11 | 매우 작은 개선 |
| 15 | -2051.4962 | +0.01 | 거의 수렴 |
| 16 | -2051.5445 | -0.05 | 악화 (수렴) |

**관찰**:
- 초기 5회 반복에서 **큰 개선** (총 +706 개선)
- 6~9회 반복에서 **중간 개선** (총 +107 개선)
- 10~15회 반복에서 **매우 작은 개선** (총 +0.78 개선)
- 16회에서 악화 → **수렴 완료**

---

## ⚠️ 문제점 요약

### 1. 심각한 스케일 불균형

| 지표 | 값 | 상태 |
|------|-----|------|
| 측정모델 비율 | 91.7% | ⚠️ **과도하게 큼** |
| 선택모델 비율 | 8.3% | ⚠️ **과도하게 작음** |
| 비율 (측정/선택) | 11.0 | ⚠️ **심각한 불균형** |

**권장 비율**: 1:1 ~ 3:1 (측정모델이 약간 큰 것은 정상)  
**현재 비율**: **11:1** ← **심각한 불균형!**

---

### 2. 스케일링 방법의 문제

**현재 스케일링**:
- 측정모델: **20.75배 축소**
- 선택모델: **0.62배 확대**

**문제**:
- 스케일링 비율이 **과도하게 큼**
- 측정모델과 선택모델의 스케일링 비율이 **33배 차이**
- 스케일링이 **불균형을 완전히 해소하지 못함**

---

## 💡 해결 방안

### 1. 우도 가중치 (Likelihood Weighting)

**방법**: 측정모델과 선택모델에 서로 다른 가중치 적용

```python
# 가중치 계산
n_measurement_obs = 328 * 15  # 4,920
n_choice_obs = 328 * 8  # 2,624

# 균형 가중치
w_measurement = n_choice_obs / n_measurement_obs  # 0.533
w_choice = 1.0

# 가중 우도
LL_total = w_measurement * LL_measurement + w_choice * LL_choice
```

**예상 효과**:
- 측정모델 우도를 **0.533배로 축소**
- 선택모델 우도는 **그대로 유지**
- 비율: 11:1 → **5.9:1** (개선)

---

### 2. 관측치 수 정규화 (Per-Observation Likelihood)

**방법**: 관측치 수로 나누어 평균 우도 사용

```python
# 평균 우도
LL_measurement_avg = LL_measurement / n_measurement_obs
LL_choice_avg = LL_choice / n_choice_obs

# 전체 우도
LL_total = LL_measurement_avg + LL_choice_avg
```

**예상 효과**:
- 측정모델: -14758.4389 / 4920 = **-3.00**
- 선택모델: -1340.6232 / 2624 = **-0.51**
- 비율: 11:1 → **5.9:1** (개선)

---

### 3. 2단계 추정 (Sequential Estimation)

**방법**: 측정모델과 선택모델을 순차적으로 추정

**1단계**: 측정모델만 추정 (CFA)
**2단계**: 측정모델 고정, 선택모델만 추정

**장점**:
- 스케일 불균형 문제 **완전히 해소**
- 각 모델을 **독립적으로 최적화**

**단점**:
- 동시추정의 장점 상실 (효율성 감소)

---

## 🎯 권장 조치

### 즉시 실행 (Priority 1)

**1. 우도 가중치 적용**:
```python
# simultaneous_estimator_fixed.py에 추가
self.measurement_weight = 0.533  # 측정모델 가중치
self.choice_weight = 1.0  # 선택모델 가중치

# 우도 계산 시
LL_total = (self.measurement_weight * LL_measurement + 
            self.choice_weight * LL_choice)
```

**2. 가중치 효과 검증**:
- 통합 테스트에 가중치 테스트 추가
- 실제 동시추정 실행 후 비율 확인

---

### 단기 실행 (Priority 2)

**3. 관측치 수 정규화 옵션 추가**:
```python
# Config에 옵션 추가
normalize_by_n_obs: bool = False  # 디폴트: False

# 활성화 시 평균 우도 사용
if self.config.normalize_by_n_obs:
    LL_measurement /= n_measurement_obs
    LL_choice /= n_choice_obs
```

**4. 스케일 균형 모니터링**:
- 각 반복마다 측정모델/선택모델 비율 출력
- 비율이 5:1 이상이면 경고 메시지

---

### 중기 실행 (Priority 3)

**5. 2단계 추정과 비교**:
- 순차추정 결과와 동시추정 결과 비교
- 파라미터 추정치 차이 분석
- 표준오차 차이 분석

**6. 문헌 조사**:
- ICLV 모델의 우도 스케일링 방법 조사
- 선행 연구에서 사용한 가중치 확인


