# 우도 스케일 균형 분석 요약

**작성일**: 2025-11-26  
**분석 대상**: 동시추정 로그 (`simultaneous_estimation_log_20251126_144000.txt`)

---

## 🚨 핵심 발견: 심각한 스케일 불균형

### 최종 우도 성분 (언스케일링)

```
전체 로그우도: -16095.5154

📈 모델별 우도 성분:
  측정모델: -14758.4389 (91.7%) ← ⚠️ 압도적으로 큼
  선택모델:  -1340.6232 ( 8.3%) ← ⚠️ 매우 작음
  
비율: 측정모델 / 선택모델 = 11.0 : 1
```

---

## 📊 비교 분석

### 초기 vs 최종

| 상태 | 측정모델 | 선택모델 | 비율 (측정/선택) |
|------|---------|---------|-----------------|
| **초기 (스케일링)** | -711.18 (24.8%) | -2148.95 (74.9%) | 0.33 : 1 |
| **최종 (언스케일링)** | -14758.44 (91.7%) | -1340.62 (8.3%) | **11.0 : 1** |

### 스케일링 효과

| 모델 | 스케일링 | 언스케일링 | 스케일링 비율 |
|------|---------|-----------|--------------|
| 측정모델 | -711.18 | -14758.44 | **20.75배 축소** |
| 선택모델 | -2148.95 | -1340.62 | **0.62배 확대** |

**문제**: 스케일링 비율이 **33배 차이** (20.75 / 0.62)

---

## ⚠️ 문제점

### 1. 측정모델 우도가 과도하게 큼

**원인**:
- **관측치 수**: 측정모델 4,920개 vs 선택모델 2,624개 (1.9배)
- **모델 복잡도**: 측정모델 15개 방정식 vs 선택모델 1개 방정식 (15배)
- **우도 누적**: 측정모델은 각 지표마다 우도 계산

**결과**:
- 측정모델 우도가 선택모델의 **11배**
- 권장 비율 (1:1 ~ 3:1)을 **크게 초과**

---

### 2. 최적화 편향

**그래디언트 불균형**:
- 측정모델 파라미터의 그래디언트가 **과도하게 큼**
- 선택모델 파라미터의 그래디언트가 **상대적으로 작음**

**파라미터 추정 편향**:
- 측정모델 파라미터: **과도하게 정밀하게 추정**
- 선택모델 파라미터: **상대적으로 덜 정밀하게 추정**
- **동시추정의 장점 상실**

---

## 💡 해결 방안

### 방안 1: 우도 가중치 (Likelihood Weighting) ✅ 권장

**방법**:
```python
# 관측치 수 기반 가중치
w_measurement = n_choice_obs / n_measurement_obs  # 2624 / 4920 = 0.533
w_choice = 1.0

# 가중 우도
LL_total = w_measurement * LL_measurement + w_choice * LL_choice
```

**예상 효과**:
```
측정모델: -14758.44 × 0.533 = -7866.25
선택모델: -1340.62 × 1.0 = -1340.62

비율: 7866.25 / 1340.62 = 5.9 : 1 (개선!)
```

**장점**:
- ✅ 구현 간단
- ✅ 동시추정 유지
- ✅ 비율을 5.9:1로 개선 (11:1 → 5.9:1)

**단점**:
- ⚠️ 여전히 5:1 이상 (이상적: 1:1 ~ 3:1)

---

### 방안 2: 관측치 수 정규화 (Per-Observation Likelihood)

**방법**:
```python
# 평균 우도 사용
LL_measurement_avg = LL_measurement / n_measurement_obs
LL_choice_avg = LL_choice / n_choice_obs

LL_total = LL_measurement_avg + LL_choice_avg
```

**예상 효과**:
```
측정모델: -14758.44 / 4920 = -3.00
선택모델: -1340.62 / 2624 = -0.51

비율: 3.00 / 0.51 = 5.9 : 1 (동일한 개선)
```

**장점**:
- ✅ 해석이 명확 (개인당 평균 우도)
- ✅ 동시추정 유지

**단점**:
- ⚠️ AIC/BIC 계산 시 주의 필요

---

### 방안 3: 2단계 추정 (Sequential Estimation)

**방법**:
1. **1단계**: 측정모델만 추정 (CFA)
2. **2단계**: 측정모델 고정, 선택모델만 추정

**장점**:
- ✅ 스케일 불균형 **완전히 해소**
- ✅ 각 모델 독립적으로 최적화

**단점**:
- ❌ 동시추정의 장점 상실 (효율성 감소)
- ❌ 측정오차가 선택모델에 전파

---

## 📋 권장 조치 (우선순위)

### Priority 1: 우도 가중치 적용 (즉시)

**코드 수정**:
```python
# src/analysis/hybrid_choice_model/iclv_models/simultaneous_estimator_fixed.py

class SimultaneousEstimator:
    def __init__(self, ...):
        # 관측치 수 계산
        self.n_measurement_obs = len(data) * sum(len(lv.indicators) for lv in measurement_models)
        self.n_choice_obs = len(data) * n_choice_sets
        
        # 가중치 계산
        self.measurement_weight = self.n_choice_obs / self.n_measurement_obs
        self.choice_weight = 1.0
        
    def log_likelihood(self, params):
        LL_measurement = ...
        LL_choice = ...
        
        # 가중 우도
        LL_total = (self.measurement_weight * LL_measurement + 
                    self.choice_weight * LL_choice)
        return LL_total
```

**검증**:
1. 통합 테스트에 가중치 테스트 추가
2. 실제 동시추정 실행
3. 비율 확인 (목표: 5:1 이하)

---

### Priority 2: 스케일 균형 모니터링 (단기)

**로그 출력 추가**:
```python
# 각 반복마다 비율 출력
ratio = abs(LL_measurement / LL_choice)
logger.info(f"  측정/선택 비율: {ratio:.2f}")

# 경고 메시지
if ratio > 5.0:
    logger.warning(f"⚠️ 스케일 불균형 감지! 비율: {ratio:.2f} (권장: < 5.0)")
```

---

### Priority 3: 2단계 추정과 비교 (중기)

**비교 분석**:
1. 순차추정 실행 (기존 방법)
2. 동시추정 실행 (가중치 적용)
3. 파라미터 추정치 비교
4. 표준오차 비교
5. 모델 적합도 비교 (AIC/BIC)

---

## 🎯 결론

### ⚠️ 현재 상태

- **측정모델 우도가 선택모델의 11배** (심각한 불균형)
- **최적화가 측정모델 위주로 진행** (편향)
- **동시추정의 장점이 제대로 발휘되지 않음**

### ✅ 권장 해결책

**1순위**: **우도 가중치 적용** (w_measurement = 0.533)
- 비율을 11:1 → 5.9:1로 개선
- 구현 간단, 동시추정 유지

**2순위**: 스케일 균형 모니터링 추가
- 각 반복마다 비율 확인
- 비율 > 5.0 시 경고

**3순위**: 2단계 추정과 비교
- 동시추정 vs 순차추정 성능 비교
- 최적 방법 선택

---

## 📈 예상 개선 효과

### 가중치 적용 전 (현재)

```
측정모델: -14758.44 (91.7%)
선택모델:  -1340.62 ( 8.3%)
비율: 11.0 : 1 ⚠️
```

### 가중치 적용 후 (예상)

```
측정모델: -7866.25 (85.4%)
선택모델: -1340.62 (14.6%)
비율: 5.9 : 1 ✅ (개선!)
```

**개선율**: 46% 감소 (11.0 → 5.9)

---

## 📚 참고 문헌

**ICLV 모델 스케일링 방법**:
- Ben-Akiva et al. (2002): "Integration of Choice and Latent Variable Models"
- Walker & Ben-Akiva (2002): "Generalized Random Utility Model"
- Daziano & Bolduc (2013): "Incorporating pro-environmental preferences"

**권장 비율**: 대부분의 연구에서 측정모델:선택모델 = **1:1 ~ 3:1**


