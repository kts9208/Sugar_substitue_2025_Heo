# 동시추정 파라미터 및 변수 스케일 분석

## 📊 개요

동시추정 시 각 모델별 파라미터와 변수값의 스케일을 비교 분석하여, 스케일 불균형으로 인한 최적화 문제를 파악합니다.

---

## 1. 파라미터 스케일 분석

### 1.1 측정모델 파라미터 (고정 - CFA 결과)

#### ① 요인적재량 (zeta, ζ)

**스케일:**
- **범위**: [0.389, 1.007]
- **평균**: 0.686
- **표준편차**: 0.234

**LV별 상세:**
| LV | 범위 | 평균 | 지표 수 |
|----|------|------|---------|
| **health_concern** | [0.651, 1.000] | 0.794 | 6개 |
| **perceived_benefit** | [0.394, 1.000] | 0.714 | 6개 |
| **purchase_intention** | [0.993, 1.007] | 1.000 | 3개 |
| **perceived_price** | [0.579, 1.000] | 0.825 | 3개 |
| **nutrition_knowledge** | [-0.629, 1.000] | 0.476 | 20개 |

**특징:**
- ✅ 대부분 0.4~1.0 범위
- ⚠️ nutrition_knowledge에 음수 적재량 존재 (-0.629, -0.329, -0.221)
- ✅ 첫 번째 지표는 1.0으로 고정 (식별 제약)

#### ② 오차분산 (sigma_sq, σ²)

**스케일 (CFA 결과 기준):**
- **범위**: [0.11, 1.54]
- **평균**: 0.45
- **표준편차**: 0.28

**LV별 상세:**
| LV | 범위 | 평균 |
|----|------|------|
| **health_concern** | [0.24, 0.47] | 0.36 |
| **perceived_benefit** | [0.27, 0.68] | 0.48 |
| **purchase_intention** | [1.21, 1.54] | 1.43 |
| **perceived_price** | [0.10, 0.41] | 0.24 |
| **nutrition_knowledge** | [0.11, 0.87] | 0.42 |

**특징:**
- ✅ 대부분 0.1~0.7 범위
- ⚠️ purchase_intention의 오차분산이 크다 (1.2~1.5)

#### ③ 절편 (alpha, α)

**스케일:**
- **범위**: [3.5, 6.5] (추정)
- **평균**: 5.0 (리커트 척도 중앙값 근처)

**특징:**
- ✅ 리커트 척도 (1-7)의 평균 응답값 반영
- ✅ 대부분 4~6 범위

---

### 1.2 구조모델 파라미터 (추정 대상)

#### ① 경로계수 (gamma, γ)

**초기값:**
- **모든 경로**: 0.1

**추정값 (순차추정 2단계 참고):**
- **gamma_HC_to_PB**: 0.5~0.6 (예상)
- **gamma_PB_to_PI**: 0.5~0.6 (예상)

**특징:**
- ✅ 초기값 0.1은 보수적
- ✅ 추정값은 0.5 근처로 수렴 예상
- ✅ 스케일: -1.0 ~ 1.0 범위

#### ② 오차분산 (sigma_sq_PB, σ²_PB)

**현재 설정:**
- **고정값**: 1.0 (추정 안 함)

**특징:**
- ✅ 표준화된 LV 가정 (분산 = 1.0)

---

### 1.3 선택모델 파라미터 (추정 대상)

#### ① ASC (Alternative-Specific Constants)

**초기값:**
- **asc_sugar**: 0.1
- **asc_sugar_free**: 0.1

**추정값 (순차추정 2단계 참고):**
- **asc_sugar**: 0.93 ± 0.90
- **asc_sugar_free**: 1.96 ± 0.72

**특징:**
- ⚠️ 초기값 0.1 vs 추정값 1~2: **10~20배 차이**
- ⚠️ 표준오차도 크다 (0.7~0.9)

#### ② Beta (속성 계수)

**초기값:**
- **beta_health_label**: 0.1
- **beta_price**: 0.1

**추정값 (순차추정 2단계 참고):**
- **beta_health_label**: 1.00 ± 0.70
- **beta_price**: -0.56 ± 0.37

**특징:**
- ⚠️ 초기값 0.1 vs 추정값 0.5~1.0: **5~10배 차이**

#### ③ Theta (LV 주효과)

**초기값:**
- **theta_sugar_PI**: 0.1
- **theta_sugar_free_PI**: 0.1

**추정값 (순차추정 2단계 참고):**
- **theta_sugar_PI**: -0.38 ± 0.90
- **theta_sugar_free_PI**: -0.18 ± 1.00

**특징:**
- ⚠️ 표준오차가 매우 크다 (0.9~1.0)
- ⚠️ 추정값이 불안정 (음수, 유의하지 않음)

#### ④ Gamma (LV-속성 상호작용)

**초기값:**
- **gamma_sugar_PI_price**: 0.1 (예시)

**추정값:**
- 현재 모델에는 상호작용 없음

---

## 2. 변수값 스케일 분석

### 2.1 잠재변수 (LV) 값

**스케일:**
- **분포**: 표준정규분포 N(0, 1)
- **범위**: 대부분 [-3, +3]
- **평균**: 0.0
- **표준편차**: 1.0

**Halton Draws:**
- **생성 방법**: Halton 시퀀스 → 표준정규분포 변환
- **차원**: 5개 (HC, PB, PI, PP, NK)
- **개인당 draws**: 500개

**특징:**
- ✅ 표준화된 스케일 (평균 0, 분산 1)
- ✅ 모든 LV가 동일한 스케일

---

### 2.2 선택 속성 (Choice Attributes)

#### ① 가격 (price)

**스케일:**
- **범위**: [2000, 6000] 원
- **평균**: 4000 원
- **표준편차**: 1000 원

**특징:**
- ⚠️ **매우 큰 스케일** (수천 단위)
- ⚠️ LV (0~1)와 **1000배 이상 차이**

#### ② 건강 라벨 (health_label)

**스케일:**
- **범위**: [0, 1] (이진)
- **평균**: 0.5

**특징:**
- ✅ 표준화된 스케일

#### ③ 칼로리 (calorie) - 사용 안 함

**스케일:**
- **범위**: [50, 200] kcal
- **평균**: 100 kcal

---

### 2.3 측정지표 (Indicators)

**스케일:**
- **범위**: [1, 7] (리커트 척도)
- **평균**: 4~5
- **표준편차**: 1~2

**특징:**
- ✅ 모든 지표가 동일한 스케일 (1-7)
- ✅ 표준화 불필요

---

## 3. 스케일 불균형 분석

### 3.1 파라미터 간 스케일 차이

| 파라미터 그룹 | 초기값 | 추정값 | 스케일 비율 |
|--------------|--------|--------|------------|
| **측정모델 (zeta)** | 0.4~1.0 | 0.4~1.0 | 1x (기준) |
| **측정모델 (sigma_sq)** | 0.1~1.5 | 0.1~1.5 | 1x |
| **구조모델 (gamma)** | 0.1 | 0.5~0.6 | **5~6x** |
| **선택모델 (asc)** | 0.1 | 1.0~2.0 | **10~20x** |
| **선택모델 (beta)** | 0.1 | 0.5~1.0 | **5~10x** |
| **선택모델 (theta)** | 0.1 | -0.4~0.4 | **4x** |

**문제점:**
- ⚠️ 선택모델 파라미터의 초기값이 **너무 작다** (0.1)
- ⚠️ 추정값과 **10~20배 차이**
- ⚠️ 그래디언트 크기 불균형 발생 가능

---

### 3.2 변수값 간 스케일 차이

| 변수 그룹 | 스케일 | 비고 |
|----------|--------|------|
| **LV 값** | [-3, +3] | 표준정규분포 |
| **가격 (price)** | [2000, 6000] | **1000배 차이** ⚠️ |
| **건강 라벨** | [0, 1] | 이진 |
| **측정지표** | [1, 7] | 리커트 척도 |

**문제점:**
- ⚠️ **가격 변수의 스케일이 너무 크다** (수천 단위)
- ⚠️ LV와 **1000배 이상 차이**
- ⚠️ `beta_price × price` 항이 효용함수를 지배할 가능성

---

## 4. 그래디언트 크기 비교

### 4.1 측정모델 그래디언트

**수식:**
```
∂LL_meas/∂ζ = (Y - ζ×LV) × LV / σ²
```

**크기 추정:**
- Y: 1~7
- ζ: 0.4~1.0
- LV: -3~+3
- σ²: 0.1~1.5

**그래디언트 크기**: **1~10** 정도

---

### 4.2 구조모델 그래디언트

**수식:**
```
∂LL_struct/∂γ = (∂LL/∂LV_target) × LV_predictor
```

**크기 추정:**
- ∂LL/∂LV: 1~10 (측정 + 선택)
- LV: -3~+3

**그래디언트 크기**: **3~30** 정도

---

### 4.3 선택모델 그래디언트

**수식:**
```
∂LL_choice/∂β = (y - P) × X
```

**크기 추정 (가격):**
- (y - P): -1~+1
- price: 2000~6000

**그래디언트 크기**: **2000~6000** ⚠️ **매우 크다!**

**크기 추정 (ASC):**
- (y - P): -1~+1

**그래디언트 크기**: **0.1~1** 정도

---

## 5. 스케일 불균형의 영향

### 5.1 최적화 문제

1. **그래디언트 크기 불균형**
   - beta_price 그래디언트: 2000~6000
   - asc 그래디언트: 0.1~1
   - **6000배 차이** ⚠️

2. **학습률 문제**
   - 큰 그래디언트: 발산 위험
   - 작은 그래디언트: 수렴 느림

3. **수치 불안정성**
   - Hessian 행렬의 조건수(condition number) 증가
   - L-BFGS-B 최적화 어려움

---

### 5.2 해결 방법

#### ① 파라미터 스케일링 (현재 구현됨)

**방법:**
```python
# parameter_scaler.py
scaled_param = (param - center) / scale
```

**스케일 설정:**
- asc: scale = 1.0
- beta_price: scale = 0.5
- theta: scale = 0.5

**효과:**
- ✅ 그래디언트 크기 균형
- ✅ 최적화 안정성 향상

#### ② 변수 정규화

**가격 정규화:**
```python
price_normalized = price / 1000  # 천원 단위
```

**효과:**
- ✅ 가격 스케일: 2~6 (LV와 유사)
- ✅ 그래디언트 크기: 2~6 (1000배 감소)

---

## 6. 권장 사항

### 6.1 즉시 적용 가능

1. ✅ **파라미터 스케일링 사용** (이미 구현됨)
2. ✅ **가격 변수 정규화** (천원 단위)
3. ✅ **초기값 개선**:
   - asc: 0.1 → 1.0
   - beta: 0.1 → 0.5

### 6.2 장기적 개선

1. **적응형 학습률** (Adaptive Learning Rate)
2. **그래디언트 클리핑** (Gradient Clipping)
3. **2차 최적화** (Newton-CG, Trust-Region)

---

## 7. 요약

### 7.1 주요 발견

| 항목 | 스케일 | 문제 |
|------|--------|------|
| **측정모델 파라미터** | 0.4~1.5 | ✅ 적절 |
| **구조모델 파라미터** | 0.1~0.6 | ✅ 적절 |
| **선택모델 ASC** | 0.1 → 1~2 | ⚠️ 초기값 너무 작음 |
| **선택모델 beta** | 0.1 → 0.5~1.0 | ⚠️ 초기값 너무 작음 |
| **가격 변수** | 2000~6000 | ⚠️ 스케일 너무 큼 |
| **LV 값** | -3~+3 | ✅ 표준화됨 |

### 7.2 핵심 문제

1. ⚠️ **가격 변수 스케일**: LV와 1000배 차이
2. ⚠️ **선택모델 초기값**: 추정값과 10~20배 차이
3. ⚠️ **그래디언트 불균형**: beta_price vs asc (6000배 차이)

### 7.3 해결책

1. ✅ **파라미터 스케일링** (구현됨)
2. 🔧 **가격 정규화** (권장)
3. 🔧 **초기값 개선** (권장)

