# 동시추정 수렴 실패 원인 분석 보고서

**로그 파일**: `simultaneous_estimation_log_20251123_114842.txt`  
**분석 일시**: 2025-11-23  
**최적화 설정**: Halton Draws=100, 로깅=MINIMAL, GPU 메모리=7GB

---

## 📊 전체 추정 진행 상황

| 지표 | 값 |
|------|-----|
| **총 Iteration 수** | 11회 |
| **초기 LL** | -2416.72 |
| **최종 LL** | -2052.46 |
| **LL 개선** | +364.26 (15.07% 개선) |
| **최종 상태** | **ABNORMAL 종료** ❌ |

---

## 🔍 수렴 조건 분석

### **1. ftol (함수값 변화 조건)**

| Iteration | ftol | 상태 |
|-----------|------|------|
| Iter 10 | 9.10e-04 | ✅ **만족** (< 1e-3) |
| Iter 11 | 9.10e-04 | ✅ **만족** (< 1e-3) |

**결론**: ftol 조건은 **만족**함 (최근 2회 연속)

---

### **2. gtol (Gradient norm 조건)**

| Iteration | gtol | 상태 |
|-----------|------|------|
| Iter 1 | 4.87e+02 | ❌ 불만족 |
| Iter 2 | 3.38e+02 | ❌ 불만족 |
| Iter 3 | 1.66e+02 | ❌ 불만족 |
| ... | ... | ... |
| Iter 10 | 5.61e+01 | ❌ 불만족 |
| Iter 11 | **2.29e+00** | ❌ **불만족** (> 1e-3) |

**결론**: gtol 조건은 **불만족** (기준: 1e-3, 현재: 2.29)

---

## ⚠️ Line Search 실패 분석

### **전체 통계**

| 상태 | 횟수 | 비율 |
|------|------|------|
| **성공 (OK)** | 1회 | 9.1% |
| **실패 (FAIL)** | 2회 | 18.2% |
| **정체 (WARN)** | 8회 | **72.7%** ⚠️ |

### **주요 문제점**

1. **Iteration #2**: Line Search 실패 (함수값 증가: +127.88)
2. **Iteration #5**: Line Search 실패 (함수값 증가: +5.23)
3. **Iteration #3-11**: Line Search 정체 (8회 연속)

### **Iteration #11 상세 분석**

- **Major Iteration #11 완료 후**: LL = -2052.46
- **Line Search 시도**: 40회 함수 호출
- **모든 시도에서 maxls=10 도달** (Wolfe 조건 불만족)
- **최종 결과**: ABNORMAL 종료

**Line Search 경고 메시지** (40회 반복):
```
⚠️ [Line Search 경고] maxls=10에 도달했습니다.
  시작 함수값: 2052.4733
  현재 함수값: 2052.4598
  변화량: -0.0135
  Line search가 Wolfe 조건을 만족하는 step size를 찾지 못했을 수 있습니다.
```

---

## 📈 LL 변화 추이

| Iteration | LL | 변화량 | 변화율 | 상태 |
|-----------|-----|--------|--------|------|
| 1 | -2416.72 | - | - | 초기값 |
| 2 | -2317.34 | +99.37 | +4.11% | ✅ 개선 |
| 3 | -2222.62 | +94.72 | +4.09% | ✅ 개선 |
| 4 | -2124.31 | +98.31 | +4.42% | ✅ 개선 |
| 5 | -2106.57 | +17.74 | +0.84% | ✅ 개선 |
| 6 | -2099.79 | +6.78 | +0.32% | ✅ 개선 |
| 7 | -2088.50 | +11.29 | +0.54% | ✅ 개선 |
| 8 | -2066.72 | +21.78 | +1.04% | ✅ 개선 |
| 9 | -2056.20 | +10.51 | +0.51% | ✅ 개선 |
| 10 | -2054.33 | +1.87 | +0.09% | ✅ 개선 |
| 11 | -2052.46 | +1.87 | +0.09% | ✅ 개선 |

**관찰**:
- Iteration 1-4: 빠른 개선 (4% 이상)
- Iteration 5-11: 점진적 둔화 (1% 미만)
- **최근 2회 (Iter 10-11)**: 변화량 < 2 (평탄한 영역)

---

## 🎯 수렴 실패 원인 후보군

### **[HIGH] 원인 1: Line Search 실패/정체 빈번**

**증거**: 10/11회 (90.9%)

**설명**:
- Line Search가 Wolfe 조건을 만족하는 step size를 찾지 못함
- 특히 Iteration #11에서 40회 연속 maxls=10 도달
- 탐색 방향이 부적절하거나 함수가 평탄한 영역에 도달했을 가능성

**근본 원인 추정**:
1. **Hessian 근사 부정확**: L-BFGS-B의 Hessian 근사가 실제 곡률을 제대로 반영하지 못함
2. **평탄한 영역**: 함수가 거의 평평한 영역에 도달하여 적절한 step size를 찾기 어려움
3. **수치적 불안정성**: GPU 배치 계산 과정에서 수치 오차 누적

---

### **[HIGH] 원인 2: Gradient norm이 수렴 기준을 만족하지 못함**

**증거**: 최종 gtol = 2.29 (기준: 1e-3)

**설명**:
- 그래디언트가 충분히 0에 가까워지지 않음
- 최적점에 도달하지 못했거나, 수치적 불안정성이 있을 가능성

**세부 분석**:
- Iteration 1: gtol = 487.21
- Iteration 11: gtol = 2.29
- **감소율**: 99.5% (매우 큰 개선)
- **하지만**: 여전히 기준(1e-3)의 2,290배

**근본 원인 추정**:
1. **Local minimum 미도달**: 아직 최적점에 도달하지 못함
2. **Saddle point**: 안장점에 갇혔을 가능성
3. **그래디언트 계산 오차**: Analytic gradient 계산에 수치 오차 존재

---

### **[MEDIUM] 원인 3: LL 변화 정체 (평탄한 영역)**

**증거**: 최근 5회 평균 LL 변화 = 10.46

**설명**:
- 함수값이 거의 변하지 않는 평탄한 영역에 도달
- Local minimum이거나 saddle point일 가능성

**세부 분석**:
- Iteration 1-4: 평균 변화 = 97.64 (빠른 개선)
- Iteration 7-11: 평균 변화 = 9.58 (정체)
- **둔화율**: 90.2%

---

## 💡 해결 방안 제안

### **[HIGH] 제안 1: Line Search 파라미터 조정**

**현재 설정**:
```python
maxls = 20  # Line Search 최대 횟수
```

**문제**: Iteration #11에서 maxls=10 도달 (실제로는 20이 설정되었으나 10에서 멈춤)

**제안**:
```python
options = {
    'maxls': 50,      # 20 → 50으로 증가
    'ftol': 1e-5,     # 1e-6 → 완화 (더 쉽게 수렴)
    'gtol': 1e-4,     # 1e-5 → 완화
}
```

**예상 효과**: Line Search가 더 많은 시도를 통해 적절한 step size를 찾을 가능성 증가

---

### **[HIGH] 제안 2: 초기값 개선**

**현재 설정**:
```python
# 모든 파라미터를 0.1로 초기화
initial_params = {
    'structural': {'gamma_...': 0.1, ...},
    'choice': {'asc_...': 0.1, ...}
}
```

**문제**: 초기 LL = -2416.72 (매우 낮음)

**제안**: 순차추정 2단계 결과를 더 정확하게 사용
```python
# st2_HC-PB_PB-PI1_PI2_results.csv에서 추정값 로드
stage2_results = pd.read_csv('results/final/sequential/stage2/st2_HC-PB_PB-PI1_PI2_results.csv')
initial_params = extract_initial_values_from_stage2(stage2_results)
```

**예상 효과**: 더 나은 초기값으로 시작하여 수렴 속도 향상

---

### **[MEDIUM] 제안 3: 최적화 알고리즘 변경**

**현재**: L-BFGS-B (Quasi-Newton)

**제안**: Trust Region 방법 시도
```python
optimizer = 'trust-constr'  # L-BFGS-B → trust-constr
```

**이유**:
- Trust Region은 평탄한 영역에서 더 안정적
- Hessian 근사가 부정확할 때 더 robust

---

### **[LOW] 제안 4: 수렴 기준 완화**

**현재**:
```python
ftol = 1e-6
gtol = 1e-5
```

**제안**:
```python
ftol = 1e-4  # 1e-6 → 완화
gtol = 1e-3  # 1e-5 → 완화
```

**주의**: 정확도가 다소 낮아질 수 있음

---

## 📋 요약

### **주요 문제**

1. ✗ **Line Search 90.9% 실패/정체** - Wolfe 조건 불만족
2. ✗ **gtol = 2.29** - 수렴 기준(1e-3)의 2,290배
3. ✗ **평탄한 영역 도달** - LL 변화 < 2

### **근본 원인**

1. **Hessian 근사 부정확** (L-BFGS-B)
2. **평탄한 함수 영역** (Local minimum 또는 Saddle point)
3. **초기값 부적절** (초기 LL = -2416.72)

### **권장 조치**

1. **즉시 시도**: Line Search maxls 증가 (20 → 50)
2. **중기 개선**: 순차추정 2단계 결과로 초기값 개선
3. **장기 검토**: Trust Region 알고리즘 시도

---

**분석 완료 일시**: 2025-11-23  
**분석 스크립트**: `analyze_convergence_failure.py`

